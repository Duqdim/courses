

<!DOCTYPE html>
<html class="writer-html5" lang="es" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Time series forecasting &mdash; documentación de --- Cursos --- - </title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
        <script type="text/javascript" src="../../../../_static/translations.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="A Transformer-based recommendation system" href="../../keras.io/structured_data/0-00_a_transformer-based_recommendation_system.html" />
    <link rel="prev" title="Classification on imbalanced data" href="1-03_imbalanced_data.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> --- Cursos ---
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Configuración</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">Instalación de Vagrant y Docker</a></li>
</ul>
<p class="caption"><span class="caption-text">Cursos</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica-de-grandes-datos/index.html">Analítica de grandes datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica-financiera/index.html">Analítica Financiera</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica-predictiva/index.html">Analítica Predictiva</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ciencia-de-los-datos/index.html">Ciencia de los Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fundamentos-de-analitica/index.html">Fundamentos de Analítica</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../productos-de-datos/index.html">Productos de Datos</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../redes-neuronales-con-tensorflow/index.html">Redes Neuronales Artificiales</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../../../redes-neuronales-con-tensorflow/content.html">Sesiones</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes-neuronales-con-tensorflow/course-info.html">Información del curso</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes-neuronales-con-tensorflow/programming-labs.html">Laboratorios de programación</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes-neuronales-con-tensorflow/complement.html">Material Complementario</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">--- Cursos ---</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../redes-neuronales-con-tensorflow/index.html">Redes Neuronales Artificiales</a> &raquo;</li>
        
          <li><a href="../../../../redes-neuronales-con-tensorflow/content.html">Sesiones</a> &raquo;</li>
        
      <li>Time series forecasting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../_sources/notebooks/tensorflow/tutorials/Structured_data/1-04_time_series.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Time-series-forecasting">
<h1>Time series forecasting<a class="headerlink" href="#Time-series-forecasting" title="Enlazar permanentemente con este título">¶</a></h1>
<table class="tfo-notebook-buttons" align="left"><td><p><a href="#id1"><span class="problematic" id="id2">|</span></a>743a8d78b5b648d090846089520d4758|View on TensorFlow.org</p>
</td><td><p><a href="#id3"><span class="problematic" id="id4">|</span></a>a26670bf6fe542ac8d36f74f0fb45cb3|Run in Google Colab</p>
</td><td><p><a href="#id5"><span class="problematic" id="id6">|</span></a>9951c30eed4142419acf330ae1c79314|View source on GitHub</p>
</td><td><p><a href="#id7"><span class="problematic" id="id8">|</span></a>d1aad1ebec4b4fc9b21e458225380db4|Download notebook</p>
</td></table><p>This tutorial is an introduction to time series forecasting using TensorFlow. It builds a few different styles of models including Convolutional and Recurrent Neural Networks (CNNs and RNNs).</p>
<p>This is covered in two main parts, with subsections:</p>
<ul class="simple">
<li><p>Forecast for a single timestep:</p>
<ul>
<li><p>A single feature.</p></li>
<li><p>All features.</p></li>
</ul>
</li>
<li><p>Forecast multiple steps:</p>
<ul>
<li><p>Single-shot: Make the predictions all at once.</p></li>
<li><p>Autoregressive: Make one prediction at a time and feed the output back to the model.</p></li>
</ul>
</li>
</ul>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">IPython</span>
<span class="kn">import</span> <span class="nn">IPython.display</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.grid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="The-weather-dataset">
<h2>The weather dataset<a class="headerlink" href="#The-weather-dataset" title="Enlazar permanentemente con este título">¶</a></h2>
<p>This tutorial uses a weather time series dataset recorded by the Max Planck Institute for Biogeochemistry.</p>
<p>This dataset contains 14 different features such as air temperature, atmospheric pressure, and humidity. These were collected every 10 minutes, beginning in 2003. For efficiency, you will use only the data collected between 2009 and 2016. This section of the dataset was prepared by François Chollet for his book <a class="reference external" href="https://www.manning.com/books/deep-learning-with-python">Deep Learning with Python</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">zip_path</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span>
    <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;https://storage.googleapis.com/tensorflow/tf-keras-datasets/jena_climate_2009_2016.csv.zip&#39;</span><span class="p">,</span>
    <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;jena_climate_2009_2016.csv.zip&#39;</span><span class="p">,</span>
    <span class="n">extract</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">csv_path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This tutorial will just deal with <strong>hourly predictions</strong>, so start by sub-sampling the data from 10 minute intervals to 1h:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
<span class="c1"># slice [start:stop:step], starting from index 5 take every 6th record.</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">5</span><span class="p">::</span><span class="mi">6</span><span class="p">]</span>

<span class="n">date_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Date Time&#39;</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.%m.%Y %H:%M:%S&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s take a glance at the data. Here are the first few rows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Here is the evolution of a few features over time.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">,</span> <span class="s1">&#39;p (mbar)&#39;</span><span class="p">,</span> <span class="s1">&#39;rho (g/m**3)&#39;</span><span class="p">]</span>
<span class="n">plot_features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">plot_cols</span><span class="p">]</span>
<span class="n">plot_features</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">date_time</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plot_features</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plot_features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">plot_cols</span><span class="p">][:</span><span class="mi">480</span><span class="p">]</span>
<span class="n">plot_features</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">date_time</span><span class="p">[:</span><span class="mi">480</span><span class="p">]</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plot_features</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Inspect-and-cleanup">
<h3>Inspect and cleanup<a class="headerlink" href="#Inspect-and-cleanup" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Next look at the statistics of the dataset:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="Wind-velocity">
<h4>Wind velocity<a class="headerlink" href="#Wind-velocity" title="Enlazar permanentemente con este título">¶</a></h4>
<p>One thing that should stand out is the <code class="docutils literal notranslate"><span class="pre">min</span></code> value of the wind velocity, <code class="docutils literal notranslate"><span class="pre">wv</span> <span class="pre">(m/s)</span></code> and <code class="docutils literal notranslate"><span class="pre">max.</span> <span class="pre">wv</span> <span class="pre">(m/s)</span></code> columns. This <code class="docutils literal notranslate"><span class="pre">-9999</span></code> is likely erroneous. There’s a separate wind direction column, so the velocity should be <code class="docutils literal notranslate"><span class="pre">&gt;=0</span></code>. Replace it with zeros:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">wv</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;wv (m/s)&#39;</span><span class="p">]</span>
<span class="n">bad_wv</span> <span class="o">=</span> <span class="n">wv</span> <span class="o">==</span> <span class="o">-</span><span class="mf">9999.0</span>
<span class="n">wv</span><span class="p">[</span><span class="n">bad_wv</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">max_wv</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max. wv (m/s)&#39;</span><span class="p">]</span>
<span class="n">bad_max_wv</span> <span class="o">=</span> <span class="n">max_wv</span> <span class="o">==</span> <span class="o">-</span><span class="mf">9999.0</span>
<span class="n">max_wv</span><span class="p">[</span><span class="n">bad_max_wv</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># The above inplace edits are reflected in the DataFrame</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;wv (m/s)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Feature-engineering">
<h3>Feature engineering<a class="headerlink" href="#Feature-engineering" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Before diving in to build a model it’s important to understand your data, and be sure that you’re passing the model appropriately formatted data.</p>
<div class="section" id="Wind">
<h4>Wind<a class="headerlink" href="#Wind" title="Enlazar permanentemente con este título">¶</a></h4>
<p>The last column of the data, <code class="docutils literal notranslate"><span class="pre">wd</span> <span class="pre">(deg)</span></code>, gives the wind direction in units of degrees. Angles do not make good model inputs, 360° and 0° should be close to each other, and wrap around smoothly. Direction shouldn’t matter if the wind is not blowing.</p>
<p>Right now the distribution of wind data looks like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;wd (deg)&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;wv (m/s)&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wind Direction [deg]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Wind Velocity [m/s]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>But this will be easier for the model to interpret if you convert the wind direction and velocity columns to a wind <strong>vector</strong>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">wv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;wv (m/s)&#39;</span><span class="p">)</span>
<span class="n">max_wv</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max. wv (m/s)&#39;</span><span class="p">)</span>

<span class="c1"># Convert to radians.</span>
<span class="n">wd_rad</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;wd (deg)&#39;</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span>

<span class="c1"># Calculate the wind x and y components.</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Wx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">wd_rad</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Wy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">wd_rad</span><span class="p">)</span>

<span class="c1"># Calculate the max wind x and y components.</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;max Wx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_wv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">wd_rad</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;max Wy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_wv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">wd_rad</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The distribution of wind vectors is much simpler for the model to correctly interpret.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Wx&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Wy&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wind X [m/s]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Wind Y [m/s]&#39;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Time">
<h4>Time<a class="headerlink" href="#Time" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Similarly the <code class="docutils literal notranslate"><span class="pre">Date</span> <span class="pre">Time</span></code> column is very useful, but not in this string form. Start by converting it to seconds:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">timestamp_s</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Similar to the wind direction the time in seconds is not a useful model input. Being weather data it has clear daily and yearly periodicity. There are many ways you could deal with periodicity.</p>
<p>A simple approach to convert it to a usable signal is to use <code class="docutils literal notranslate"><span class="pre">sin</span></code> and <code class="docutils literal notranslate"><span class="pre">cos</span></code> to convert the time to clear “Time of day” and “Time of year” signals:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">day</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
<span class="n">year</span> <span class="o">=</span> <span class="p">(</span><span class="mf">365.2425</span><span class="p">)</span><span class="o">*</span><span class="n">day</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Day sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">timestamp_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">day</span><span class="p">))</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Day cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">timestamp_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">day</span><span class="p">))</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">timestamp_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">year</span><span class="p">))</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Year cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">timestamp_s</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">year</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Day sin&#39;</span><span class="p">])[:</span><span class="mi">25</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Day cos&#39;</span><span class="p">])[:</span><span class="mi">25</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [h]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time of day signal&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This gives the model access to the most important frequency features. In this case you knew ahead of time which frequencies were important.</p>
<p>If you didn’t know, you can determine which frequencies are important using an <code class="docutils literal notranslate"><span class="pre">fft</span></code>. To check our assumptions, here is the <code class="docutils literal notranslate"><span class="pre">tf.signal.rfft</span></code> of the temperature over time. Note the obvious peaks at frequencies near <code class="docutils literal notranslate"><span class="pre">1/year</span></code> and <code class="docutils literal notranslate"><span class="pre">1/day</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fft</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">])</span>
<span class="n">f_per_dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fft</span><span class="p">))</span>

<span class="n">n_samples_h</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">])</span>
<span class="n">hours_per_year</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mf">365.2524</span>
<span class="n">years_per_dataset</span> <span class="o">=</span> <span class="n">n_samples_h</span><span class="o">/</span><span class="p">(</span><span class="n">hours_per_year</span><span class="p">)</span>

<span class="n">f_per_year</span> <span class="o">=</span> <span class="n">f_per_dataset</span><span class="o">/</span><span class="n">years_per_dataset</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">f_per_year</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fft</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">())])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">365.2524</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;1/Year&#39;</span><span class="p">,</span> <span class="s1">&#39;1/day&#39;</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (log scale)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Split-the-data">
<h3>Split the data<a class="headerlink" href="#Split-the-data" title="Enlazar permanentemente con este título">¶</a></h3>
<p>We’ll use a <code class="docutils literal notranslate"><span class="pre">(70%,</span> <span class="pre">20%,</span> <span class="pre">10%)</span></code> split for the training, validation, and test sets. Note the data is <strong>not</strong> being randomly shuffled before splitting. This is for two reasons.</p>
<ol class="arabic simple">
<li><p>It ensures that chopping the data into windows of consecutive samples is still possible.</p></li>
<li><p>It ensures that the validation/test results are more realistic, being evaluated on data collected after the model was trained.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">column_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)}</span>

<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mf">0.7</span><span class="p">)]</span>
<span class="n">val_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mf">0.7</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mf">0.9</span><span class="p">)]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mf">0.9</span><span class="p">):]</span>

<span class="n">num_features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Normalize-the-data">
<h3>Normalize the data<a class="headerlink" href="#Normalize-the-data" title="Enlazar permanentemente con este título">¶</a></h3>
<p>It is important to scale features before training a neural network. Normalization is a common way of doing this scaling. Subtract the mean and divide by the standard deviation of each feature.</p>
<p>The mean and standard deviation should only be computed using the training data so that the models have no access to the values in the validation and test sets.</p>
<p>It’s also arguable that the model shouldn’t have access to future values in the training set when training, and that this normalization should be done using moving averages. That’s not the focus of this tutorial, and the validation and test sets ensure that you get (somewhat) honest metrics. So in the interest of simplicity this tutorial uses a simple average.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">train_mean</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">train_std</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="n">train_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_df</span> <span class="o">-</span> <span class="n">train_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">train_std</span>
<span class="n">val_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_df</span> <span class="o">-</span> <span class="n">train_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">train_std</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_df</span> <span class="o">-</span> <span class="n">train_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">train_std</span>
</pre></div>
</div>
</div>
<p>Now peek at the distribution of the features. Some features do have long tails, but there are no obvious errors like the <code class="docutils literal notranslate"><span class="pre">-9999</span></code> wind velocity value.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span> <span class="o">-</span> <span class="n">train_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">train_std</span>
<span class="n">df_std</span> <span class="o">=</span> <span class="n">df_std</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Column&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Normalized&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Column&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Normalized&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_std</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Data-windowing">
<h2>Data windowing<a class="headerlink" href="#Data-windowing" title="Enlazar permanentemente con este título">¶</a></h2>
<p>The models in this tutorial will make a set of predictions based on a window of consecutive samples from the data.</p>
<p>The main features of the input windows are:</p>
<ul class="simple">
<li><p>The width (number of time steps) of the input and label windows</p></li>
<li><p>The time offset between them.</p></li>
<li><p>Which features are used as inputs, labels, or both.</p></li>
</ul>
<p>This tutorial builds a variety of models (including Linear, DNN, CNN and RNN models), and uses them for both:</p>
<ul class="simple">
<li><p><em>Single-output</em>, and <em>multi-output</em> predictions.</p></li>
<li><p><em>Single-time-step</em> and <em>multi-time-step</em> predictions.</p></li>
</ul>
<p>This section focuses on implementing the data windowing so that it can be reused for all of those models.</p>
<p>Depending on the task and type of model you may want to generate a variety of data windows. Here are some examples:</p>
<ol class="arabic simple">
<li><p>For example, to make a single prediction 24h into the future, given 24h of history you might define a window like this:</p></li>
</ol>
<p><img alt="One prediction 24h into the future." src="../../../../_images/raw_window_24h.png" /></p>
<ol class="arabic simple" start="2">
<li><p>A model that makes a prediction 1h into the future, given 6h of history would need a window like this:</p></li>
</ol>
<p><img alt="One prediction 1h into the future." src="../../../../_images/raw_window_1h.png" /></p>
<p>The rest of this section defines a <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> class. This class can:</p>
<ol class="arabic simple">
<li><p>Handle the indexes and offsets as shown in the diagrams above.</p></li>
<li><p>Split windows of features into a <code class="docutils literal notranslate"><span class="pre">(features,</span> <span class="pre">labels)</span></code> pairs.</p></li>
<li><p>Plot the content of the resulting windows.</p></li>
<li><p>Efficiently generate batches of these windows from the training, evaluation, and test data, using <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code>s.</p></li>
</ol>
<div class="section" id="1.-Indexes-and-offsets">
<h3>1. Indexes and offsets<a class="headerlink" href="#1.-Indexes-and-offsets" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Start by creating the <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> class. The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method includes all the necessary logic for the input and label indices.</p>
<p>It also takes the train, eval, and test dataframes as input. These will be converted to <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code>s of windows later.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">WindowGenerator</span><span class="p">():</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_width</span><span class="p">,</span> <span class="n">label_width</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span>
               <span class="n">train_df</span><span class="o">=</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="o">=</span><span class="n">val_df</span><span class="p">,</span> <span class="n">test_df</span><span class="o">=</span><span class="n">test_df</span><span class="p">,</span>
               <span class="n">label_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Store the raw data.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val_df</span> <span class="o">=</span> <span class="n">val_df</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">test_df</span> <span class="o">=</span> <span class="n">test_df</span>

    <span class="c1"># Work out the label column indices.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label_columns</span> <span class="o">=</span> <span class="n">label_columns</span>
    <span class="k">if</span> <span class="n">label_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">label_columns_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span>
                                    <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_columns</span><span class="p">)}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">column_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span>
                           <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)}</span>

    <span class="c1"># Work out the window parameters.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_width</span> <span class="o">=</span> <span class="n">input_width</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label_width</span> <span class="o">=</span> <span class="n">label_width</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">total_window_size</span> <span class="o">=</span> <span class="n">input_width</span> <span class="o">+</span> <span class="n">shift</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">input_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">input_width</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">input_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_window_size</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_slice</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">label_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_window_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_width</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">labels_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_start</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_window_size</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_slice</span><span class="p">]</span>

  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
        <span class="sa">f</span><span class="s1">&#39;Total window size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_window_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;Input indices: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_indices</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;Label indices: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label_indices</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;Label column name(s): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label_columns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Here is code to create the 2 windows shown in the diagrams at the start of this section:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">w1</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span><span class="n">input_width</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">label_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                     <span class="n">label_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">])</span>
<span class="n">w1</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">w2</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span><span class="n">input_width</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">label_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">label_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">])</span>
<span class="n">w2</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="2.-Split">
<h3>2. Split<a class="headerlink" href="#2.-Split" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Given a list consecutive inputs, the <code class="docutils literal notranslate"><span class="pre">split_window</span></code> method will convert them to a window of inputs and a window of labels.</p>
<p>The example <code class="docutils literal notranslate"><span class="pre">w2</span></code>, above, will be split like this:</p>
<p><img alt="The initial window is all consecutive samples, this splits it into an (inputs, labels) pairs" src="../../../../_images/split_window.png" /></p>
<p>This diagram doesn’t show the <code class="docutils literal notranslate"><span class="pre">features</span></code> axis of the data, but this <code class="docutils literal notranslate"><span class="pre">split_window</span></code> function also handles the <code class="docutils literal notranslate"><span class="pre">label_columns</span></code> so it can be used for both the single output and multi-output examples.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">split_window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
  <span class="n">inputs</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_slice</span><span class="p">,</span> <span class="p">:]</span>
  <span class="n">labels</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_slice</span><span class="p">,</span> <span class="p">:]</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">[</span><span class="n">labels</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_indices</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_columns</span><span class="p">],</span>
        <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

  <span class="c1"># Slicing doesn&#39;t preserve static shape information, so set the shapes</span>
  <span class="c1"># manually. This way the `tf.data.Datasets` are easier to inspect.</span>
  <span class="n">inputs</span><span class="o">.</span><span class="n">set_shape</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_width</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
  <span class="n">labels</span><span class="o">.</span><span class="n">set_shape</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_width</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span>

<span class="n">WindowGenerator</span><span class="o">.</span><span class="n">split_window</span> <span class="o">=</span> <span class="n">split_window</span>
</pre></div>
</div>
</div>
<p>Try it out:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Stack three slices, the length of the total window:</span>
<span class="n">example_window</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_df</span><span class="p">[:</span><span class="n">w2</span><span class="o">.</span><span class="n">total_window_size</span><span class="p">]),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">100</span><span class="o">+</span><span class="n">w2</span><span class="o">.</span><span class="n">total_window_size</span><span class="p">]),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="mi">200</span><span class="p">:</span><span class="mi">200</span><span class="o">+</span><span class="n">w2</span><span class="o">.</span><span class="n">total_window_size</span><span class="p">])])</span>


<span class="n">example_inputs</span><span class="p">,</span> <span class="n">example_labels</span> <span class="o">=</span> <span class="n">w2</span><span class="o">.</span><span class="n">split_window</span><span class="p">(</span><span class="n">example_window</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All shapes are: (batch, time, features)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Window shape: </span><span class="si">{</span><span class="n">example_window</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Inputs shape: </span><span class="si">{</span><span class="n">example_inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;labels shape: </span><span class="si">{</span><span class="n">example_labels</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Typically data in TensorFlow is packed into arrays where the outermost index is across examples (the “batch” dimension). The middle indices are the “time” or “space” (width, height) dimension(s). The innermost indices are the features.</p>
<p>The code above took a batch of 3, 7-timestep windows, with 19 features at each time step. It split them into a batch of 6-timestep, 19 feature inputs, and a 1-timestep 1-feature label. The label only has one feature because the <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> was initialized with <code class="docutils literal notranslate"><span class="pre">label_columns=['T</span> <span class="pre">(degC)']</span></code>. Initially this tutorial will build models that predict single output labels.</p>
</div>
<div class="section" id="3.-Plot">
<h3>3. Plot<a class="headerlink" href="#3.-Plot" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Here is a plot method that allows a simple visualization of the split window:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">w2</span><span class="o">.</span><span class="n">example</span> <span class="o">=</span> <span class="n">example_inputs</span><span class="p">,</span> <span class="n">example_labels</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_col</span><span class="o">=</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">,</span> <span class="n">max_subplots</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
  <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">example</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
  <span class="n">plot_col_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_indices</span><span class="p">[</span><span class="n">plot_col</span><span class="p">]</span>
  <span class="n">max_n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_subplots</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_n</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">max_n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">plot_col</span><span class="si">}</span><span class="s1"> [normed]&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_indices</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="n">plot_col_index</span><span class="p">],</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Inputs&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_columns</span><span class="p">:</span>
      <span class="n">label_col_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_columns_indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">plot_col</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">label_col_index</span> <span class="o">=</span> <span class="n">plot_col_index</span>

    <span class="k">if</span> <span class="n">label_col_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">continue</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_indices</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="n">label_col_index</span><span class="p">],</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Labels&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_indices</span><span class="p">,</span> <span class="n">predictions</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="n">label_col_index</span><span class="p">],</span>
                  <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predictions&#39;</span><span class="p">,</span>
                  <span class="n">c</span><span class="o">=</span><span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time [h]&#39;</span><span class="p">)</span>

<span class="n">WindowGenerator</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span>
</pre></div>
</div>
</div>
<p>This plot aligns inputs, labels, and (later) predictions based on the time that the item refers to:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">w2</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>You can plot the other columns, but the example window <code class="docutils literal notranslate"><span class="pre">w2</span></code> configuration only has labels for the <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">(degC)</span></code> column.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">w2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_col</span><span class="o">=</span><span class="s1">&#39;p (mbar)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="4.-Create-tf.data.Datasets">
<h3>4. Create <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code>s<a class="headerlink" href="#4.-Create-tf.data.Datasets" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Finally this <code class="docutils literal notranslate"><span class="pre">make_dataset</span></code> method will take a time series <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> and convert it to a <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> of <code class="docutils literal notranslate"><span class="pre">(input_window,</span> <span class="pre">label_window)</span></code> pairs using the <code class="docutils literal notranslate"><span class="pre">preprocessing.timeseries_dataset_from_array</span></code> function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">make_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
  <span class="n">ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">timeseries_dataset_from_array</span><span class="p">(</span>
      <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
      <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">sequence_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_window_size</span><span class="p">,</span>
      <span class="n">sequence_stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
      <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,)</span>

  <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_window</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">ds</span>

<span class="n">WindowGenerator</span><span class="o">.</span><span class="n">make_dataset</span> <span class="o">=</span> <span class="n">make_dataset</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> object holds training, validation and test data. Add properties for accessing them as <code class="docutils literal notranslate"><span class="pre">tf.data.Datasets</span></code> using the above <code class="docutils literal notranslate"><span class="pre">make_dataset</span></code> method. Also add a standard example batch for easy access and plotting:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_df</span><span class="p">)</span>

<span class="nd">@property</span>
<span class="k">def</span> <span class="nf">val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_df</span><span class="p">)</span>

<span class="nd">@property</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_df</span><span class="p">)</span>

<span class="nd">@property</span>
<span class="k">def</span> <span class="nf">example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Get and cache an example batch of `inputs, labels` for plotting.&quot;&quot;&quot;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_example&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># No example batch was found, so get one from the `.train` dataset</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">))</span>
    <span class="c1"># And cache it for next time</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_example</span> <span class="o">=</span> <span class="n">result</span>
  <span class="k">return</span> <span class="n">result</span>

<span class="n">WindowGenerator</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span>
<span class="n">WindowGenerator</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
<span class="n">WindowGenerator</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span>
<span class="n">WindowGenerator</span><span class="o">.</span><span class="n">example</span> <span class="o">=</span> <span class="n">example</span>
</pre></div>
</div>
</div>
<p>Now the <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> object gives you access to the <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> objects, so you can easily iterate over the data.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Dataset.element_spec</span></code> property tells you the structure, <code class="docutils literal notranslate"><span class="pre">dtypes</span></code> and shapes of the dataset elements.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Each element is an (inputs, label) pair</span>
<span class="n">w2</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">element_spec</span>
</pre></div>
</div>
</div>
<p>Iterating over a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> yields concrete batches:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">example_inputs</span><span class="p">,</span> <span class="n">example_labels</span> <span class="ow">in</span> <span class="n">w2</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Inputs shape (batch, time, features): </span><span class="si">{</span><span class="n">example_inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Labels shape (batch, time, features): </span><span class="si">{</span><span class="n">example_labels</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Single-step-models">
<h2>Single step models<a class="headerlink" href="#Single-step-models" title="Enlazar permanentemente con este título">¶</a></h2>
<p>The simplest model you can build on this sort of data is one that predicts a single feature’s value, 1 timestep (1h) in the future based only on the current conditions.</p>
<p>So start by building models to predict the <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">(degC)</span></code> value 1h into the future.</p>
<p><img alt="Predict the next time step" src="../../../../_images/narrow_window.png" /></p>
<p>Configure a <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> object to produce these single-step <code class="docutils literal notranslate"><span class="pre">(input,</span> <span class="pre">label)</span></code> pairs:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">single_step_window</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span>
    <span class="n">input_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">label_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">])</span>
<span class="n">single_step_window</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">window</span></code> object creates <code class="docutils literal notranslate"><span class="pre">tf.data.Datasets</span></code> from the training, validation, and test sets, allowing you to easily iterate over batches of data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">example_inputs</span><span class="p">,</span> <span class="n">example_labels</span> <span class="ow">in</span> <span class="n">single_step_window</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Inputs shape (batch, time, features): </span><span class="si">{</span><span class="n">example_inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Labels shape (batch, time, features): </span><span class="si">{</span><span class="n">example_labels</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Baseline">
<h3>Baseline<a class="headerlink" href="#Baseline" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Before building a trainable model it would be good to have a performance baseline as a point for comparison with the later more complicated models.</p>
<p>This first task is to predict temperature 1h in the future given the current value of all features. The current values include the current temperature.</p>
<p>So start with a model that just returns the current temperature as the prediction, predicting “No change”. This is a reasonable baseline since temperature changes slowly. Of course, this baseline will work less well if you make a prediction further in the future.</p>
<p><img alt="Send the input to the output" src="../../../../_images/baseline.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">Baseline</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label_index</span> <span class="o">=</span> <span class="n">label_index</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">inputs</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_index</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Instantiate and evaluate this model:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">baseline</span> <span class="o">=</span> <span class="n">Baseline</span><span class="p">(</span><span class="n">label_index</span><span class="o">=</span><span class="n">column_indices</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">])</span>

<span class="n">baseline</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">()])</span>

<span class="n">val_performance</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">performance</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">single_step_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">single_step_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>That printed some performance metrics, but those don’t give you a feeling for how well the model is doing.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> has a plot method, but the plots won’t be very interesting with only a single sample. So, create a wider <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> that generates windows 24h of consecutive inputs and labels at a time.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">wide_window</span></code> doesn’t change the way the model operates. The model still makes predictions 1h into the future based on a single input time step. Here the <code class="docutils literal notranslate"><span class="pre">time</span></code> axis acts like the <code class="docutils literal notranslate"><span class="pre">batch</span></code> axis: Each prediction is made independently with no interaction between time steps.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">wide_window</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span>
    <span class="n">input_width</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">label_width</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">label_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">])</span>

<span class="n">wide_window</span>
</pre></div>
</div>
</div>
<p>This expanded window can be passed directly to the same <code class="docutils literal notranslate"><span class="pre">baseline</span></code> model without any code changes. This is possible because the inputs and labels have the same number of timesteps, and the baseline just forwards the input to the output:</p>
<p><img alt="One prediction 1h into the future, ever hour." src="../../../../_images/last_window.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input shape:&#39;</span><span class="p">,</span> <span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">baseline</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Plotting the baseline model’s predictions you can see that it is simply the labels, shifted right by 1h.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">wide_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In the above plots of three examples the single step model is run over the course of 24h. This deserves some explanation:</p>
<ul class="simple">
<li><p>The blue “Inputs” line shows the input temperature at each time step. The model recieves all features, this plot only shows the temperature.</p></li>
<li><p>The green “Labels” dots show the target prediction value. These dots are shown at the prediction time, not the input time. That is why the range of labels is shifted 1 step relative to the inputs.</p></li>
<li><p>The orange “Predictions” crosses are the model’s prediction’s for each output time step. If the model were predicting perfectly the predictions would land directly on the “labels”.</p></li>
</ul>
</div>
<div class="section" id="Linear-model">
<h3>Linear model<a class="headerlink" href="#Linear-model" title="Enlazar permanentemente con este título">¶</a></h3>
<p>The simplest <strong>trainable</strong> model you can apply to this task is to insert linear transformation between the input and output. In this case the output from a time step only depends on that step:</p>
<p><img alt="A single step prediction" src="../../../../_images/wide_window.png" /></p>
<p>A <code class="docutils literal notranslate"><span class="pre">layers.Dense</span></code> with no <code class="docutils literal notranslate"><span class="pre">activation</span></code> set is a linear model. The layer only transforms the last axis of the data from <code class="docutils literal notranslate"><span class="pre">(batch,</span> <span class="pre">time,</span> <span class="pre">inputs)</span></code> to <code class="docutils literal notranslate"><span class="pre">(batch,</span> <span class="pre">time,</span> <span class="pre">units)</span></code>, it is applied independently to every item across the <code class="docutils literal notranslate"><span class="pre">batch</span></code> and <code class="docutils literal notranslate"><span class="pre">time</span></code> axes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">linear</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input shape:&#39;</span><span class="p">,</span> <span class="n">single_step_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">linear</span><span class="p">(</span><span class="n">single_step_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This tutorial trains many models, so package the training procedure into a function:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">MAX_EPOCHS</span> <span class="o">=</span> <span class="mi">20</span>

<span class="k">def</span> <span class="nf">compile_and_fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="n">early_stopping</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;val_loss&#39;</span><span class="p">,</span>
                                                    <span class="n">patience</span><span class="o">=</span><span class="n">patience</span><span class="p">,</span>
                                                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">)</span>

  <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(),</span>
                <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">()])</span>

  <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">MAX_EPOCHS</span><span class="p">,</span>
                      <span class="n">validation_data</span><span class="o">=</span><span class="n">window</span><span class="o">.</span><span class="n">val</span><span class="p">,</span>
                      <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">early_stopping</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">history</span>
</pre></div>
</div>
</div>
<p>Train the model and evaluate its performance:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">single_step_window</span><span class="p">)</span>

<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;Linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">single_step_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;Linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linear</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">single_step_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Like the <code class="docutils literal notranslate"><span class="pre">baseline</span></code> model, the linear model can be called on batches of wide windows. Used this way the model makes a set of independent predictions on consecutive time steps. The <code class="docutils literal notranslate"><span class="pre">time</span></code> axis acts like another <code class="docutils literal notranslate"><span class="pre">batch</span></code> axis. There are no interactions between the predictions at each time step.</p>
<p><img alt="A single step prediction" src="../../../../_images/wide_window.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input shape:&#39;</span><span class="p">,</span> <span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">baseline</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Here is the plot of its example predictions on the <code class="docutils literal notranslate"><span class="pre">wide_window</span></code>, note how in many cases the prediction is clearly better than just returning the input temperature, but in a few cases it’s worse:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">wide_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">linear</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>One advantage to linear models is that they’re relatively simple to interpret. You can pull out the layer’s weights, and see the weight assigned to each input:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span>
        <span class="n">height</span><span class="o">=</span><span class="n">linear</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kernel</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">axis</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Sometimes the model doesn’t even place the most weight on the input <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">(degC)</span></code>. This is one of the risks of random initialization.</p>
</div>
<div class="section" id="Dense">
<h3>Dense<a class="headerlink" href="#Dense" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Before applying models that actually operate on multiple time-steps, it’s worth checking the performance of deeper, more powerful, single input step models.</p>
<p>Here’s a model similar to the <code class="docutils literal notranslate"><span class="pre">linear</span></code> model, except it stacks several a few <code class="docutils literal notranslate"><span class="pre">Dense</span></code> layers between the input and the output:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">dense</span><span class="p">,</span> <span class="n">single_step_window</span><span class="p">)</span>

<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;Dense&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dense</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">single_step_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;Dense&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dense</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">single_step_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Multi-step-dense">
<h3>Multi-step dense<a class="headerlink" href="#Multi-step-dense" title="Enlazar permanentemente con este título">¶</a></h3>
<p>A single-time-step model has no context for the current values of its inputs. It can’t see how the input features are changing over time. To address this issue the model needs access to multiple time steps when making predictions:</p>
<p><img alt="Three time steps are used for each prediction." src="../../../../_images/conv_window.png" /></p>
<p>The <code class="docutils literal notranslate"><span class="pre">baseline</span></code>, <code class="docutils literal notranslate"><span class="pre">linear</span></code> and <code class="docutils literal notranslate"><span class="pre">dense</span></code> models handled each time step independently. Here the model will take multiple time steps as input to produce a single output.</p>
<p>Create a <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> that will produce batches of the 3h of inputs and, 1h of labels:</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">Window</span></code>’s <code class="docutils literal notranslate"><span class="pre">shift</span></code> parameter is relative to the end of the two windows.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">CONV_WIDTH</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">conv_window</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span>
    <span class="n">input_width</span><span class="o">=</span><span class="n">CONV_WIDTH</span><span class="p">,</span>
    <span class="n">label_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">label_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">])</span>

<span class="n">conv_window</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">conv_window</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Given 3h as input, predict 1h into the future.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You could train a <code class="docutils literal notranslate"><span class="pre">dense</span></code> model on a multiple-input-step window by adding a <code class="docutils literal notranslate"><span class="pre">layers.Flatten</span></code> as the first layer of the model:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">multi_step_dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="c1"># Shape: (time, features) =&gt; (time*features)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="c1"># Add back the time dimension.</span>
    <span class="c1"># Shape: (outputs) =&gt; (1, outputs)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input shape:&#39;</span><span class="p">,</span> <span class="n">conv_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">multi_step_dense</span><span class="p">(</span><span class="n">conv_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">multi_step_dense</span><span class="p">,</span> <span class="n">conv_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;Multi step dense&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_step_dense</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">conv_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;Multi step dense&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_step_dense</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">conv_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">conv_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">multi_step_dense</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The main down-side of this approach is that the resulting model can only be executed on input windows of exactly this shape.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input shape:&#39;</span><span class="p">,</span> <span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">multi_step_dense</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The convolutional models in the next section fix this problem.</p>
</div>
<div class="section" id="Convolution-neural-network">
<h3>Convolution neural network<a class="headerlink" href="#Convolution-neural-network" title="Enlazar permanentemente con este título">¶</a></h3>
<p>A convolution layer (<code class="docutils literal notranslate"><span class="pre">layers.Conv1D</span></code>) also takes multiple time steps as input to each prediction.</p>
<p>Below is the <strong>same</strong> model as <code class="docutils literal notranslate"><span class="pre">multi_step_dense</span></code>, re-written with a convolution.</p>
<p>Note the changes: * The <code class="docutils literal notranslate"><span class="pre">layers.Flatten</span></code> and the first <code class="docutils literal notranslate"><span class="pre">layers.Dense</span></code> are replaced by a <code class="docutils literal notranslate"><span class="pre">layers.Conv1D</span></code>. * The <code class="docutils literal notranslate"><span class="pre">layers.Reshape</span></code> is no longer necessary since the convolution keeps the time axis in its output.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">conv_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                           <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">CONV_WIDTH</span><span class="p">,),</span>
                           <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<p>Run it on an example batch to see that the model produces outputs with the expected shape:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conv model on `conv_window`&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input shape:&#39;</span><span class="p">,</span> <span class="n">conv_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">conv_model</span><span class="p">(</span><span class="n">conv_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Train and evaluate it on the <code class="docutils literal notranslate"><span class="pre">conv_window</span></code> and it should give performance similar to the <code class="docutils literal notranslate"><span class="pre">multi_step_dense</span></code> model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">conv_model</span><span class="p">,</span> <span class="n">conv_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;Conv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">conv_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;Conv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">conv_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The difference between this <code class="docutils literal notranslate"><span class="pre">conv_model</span></code> and the <code class="docutils literal notranslate"><span class="pre">multi_step_dense</span></code> model is that the <code class="docutils literal notranslate"><span class="pre">conv_model</span></code> can be run on inputs of any length. The convolutional layer is applied to a sliding window of inputs:</p>
<p><img alt="Executing a convolutional model on a sequence" src="../../../../_images/wide_conv_window.png" /></p>
<p>If you run it on wider input, it produces wider output:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wide window&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input shape:&#39;</span><span class="p">,</span> <span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels shape:&#39;</span><span class="p">,</span> <span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">conv_model</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that the output is shorter than the input. To make training or plotting work, you need the labels, and prediction to have the same length. So build a <code class="docutils literal notranslate"><span class="pre">WindowGenerator</span></code> to produce wide windows with a few extra input time steps so the label and prediction lengths match:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">LABEL_WIDTH</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">INPUT_WIDTH</span> <span class="o">=</span> <span class="n">LABEL_WIDTH</span> <span class="o">+</span> <span class="p">(</span><span class="n">CONV_WIDTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">wide_conv_window</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span>
    <span class="n">input_width</span><span class="o">=</span><span class="n">INPUT_WIDTH</span><span class="p">,</span>
    <span class="n">label_width</span><span class="o">=</span><span class="n">LABEL_WIDTH</span><span class="p">,</span>
    <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">label_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T (degC)&#39;</span><span class="p">])</span>

<span class="n">wide_conv_window</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wide conv window&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input shape:&#39;</span><span class="p">,</span> <span class="n">wide_conv_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Labels shape:&#39;</span><span class="p">,</span> <span class="n">wide_conv_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">conv_model</span><span class="p">(</span><span class="n">wide_conv_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now you can plot the model’s predictions on a wider window. Note the 3 input time steps before the first prediction. Every prediction here is based on the 3 preceding timesteps:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">wide_conv_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">conv_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Recurrent-neural-network">
<h3>Recurrent neural network<a class="headerlink" href="#Recurrent-neural-network" title="Enlazar permanentemente con este título">¶</a></h3>
<p>A Recurrent Neural Network (RNN) is a type of neural network well-suited to time series data. RNNs process a time series step-by-step, maintaining an internal state from time-step to time-step.</p>
<p>For more details, read the <a class="reference external" href="https://www.tensorflow.org/tutorials/text/text_generation">text generation tutorial</a> or the <a class="reference external" href="https://www.tensorflow.org/guide/keras/rnn">RNN guide</a>.</p>
<p>In this tutorial, you will use an RNN layer called Long Short Term Memory (<a class="reference external" href="https://www.tensorflow.org/versions/r2.0/api_docs/python/tf/keras/layers/LSTM">LSTM</a>).</p>
<p>An important constructor argument for all keras RNN layers is the <code class="docutils literal notranslate"><span class="pre">return_sequences</span></code> argument. This setting can configure the layer in one of two ways.</p>
<ol class="arabic simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">False</span></code>, the default, the layer only returns the output of the final timestep, giving the model time to warm up its internal state before making a single prediction:</p></li>
</ol>
<p><img alt="An lstm warming up and making a single prediction" src="../../../../_images/lstm_1_window.png" /></p>
<ol class="arabic simple" start="2">
<li><p>If <code class="docutils literal notranslate"><span class="pre">True</span></code> the layer returns an output for each input. This is useful for:</p></li>
</ol>
<ul class="simple">
<li><p>Stacking RNN layers.</p></li>
<li><p>Training a model on multiple timesteps simultaneously.</p></li>
</ul>
<p><img alt="An lstm making a prediction after every timestep" src="../../../../_images/lstm_many_window.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lstm_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="c1"># Shape [batch, time, features] =&gt; [batch, time, lstm_units]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="c1"># Shape =&gt; [batch, time, features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">return_sequences=True</span></code> the model can be trained on 24h of data at a time.</p>
<p>Note: This will give a pessimistic view of the model’s performance. On the first timestep the model has no access to previous steps, and so can’t do any better than the simple <code class="docutils literal notranslate"><span class="pre">linear</span></code> and <code class="docutils literal notranslate"><span class="pre">dense</span></code> models shown earlier.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Input shape:&#39;</span><span class="p">,</span> <span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape:&#39;</span><span class="p">,</span> <span class="n">lstm_model</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">lstm_model</span><span class="p">,</span> <span class="n">wide_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">wide_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lstm_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Performance">
<h3>Performance<a class="headerlink" href="#Performance" title="Enlazar permanentemente con este título">¶</a></h3>
<p>With this dataset typically each of the models does slightly better than the one before it.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">performance</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;mean_absolute_error&#39;</span>
<span class="n">metric_index</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">metrics_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">)</span>
<span class="n">val_mae</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">metric_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val_performance</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">metric_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">performance</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mean_absolute_error [T (degC), normalized]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.17</span><span class="p">,</span> <span class="n">val_mae</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.17</span><span class="p">,</span> <span class="n">test_mae</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">performance</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
           <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">performance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s1">12s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Multi-output-models">
<h3>Multi-output models<a class="headerlink" href="#Multi-output-models" title="Enlazar permanentemente con este título">¶</a></h3>
<p>The models so far all predicted a single output feature, <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">(degC)</span></code>, for a single time step.</p>
<p>All of these models can be converted to predict multiple features just by changing the number of units in the output layer and adjusting the training windows to include all features in the <code class="docutils literal notranslate"><span class="pre">labels</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">single_step_window</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span>
    <span class="c1"># `WindowGenerator` returns all features as labels if you</span>
    <span class="c1"># don&#39;t set the `label_columns` argument.</span>
    <span class="n">input_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">wide_window</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span>
    <span class="n">input_width</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">label_width</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">example_inputs</span><span class="p">,</span> <span class="n">example_labels</span> <span class="ow">in</span> <span class="n">wide_window</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Inputs shape (batch, time, features): </span><span class="si">{</span><span class="n">example_inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Labels shape (batch, time, features): </span><span class="si">{</span><span class="n">example_labels</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note above that the <code class="docutils literal notranslate"><span class="pre">features</span></code> axis of the labels now has the same depth as the inputs, instead of 1.</p>
<div class="section" id="id9">
<h4>Baseline<a class="headerlink" href="#id9" title="Enlazar permanentemente con este título">¶</a></h4>
<p>The same baseline model can be used here, but this time repeating all features instead of selecting a specific <code class="docutils literal notranslate"><span class="pre">label_index</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">baseline</span> <span class="o">=</span> <span class="n">Baseline</span><span class="p">()</span>
<span class="n">baseline</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">()])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">val_performance</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">performance</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;Baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseline</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id10">
<h4>Dense<a class="headerlink" href="#id10" title="Enlazar permanentemente con este título">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">num_features</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">dense</span><span class="p">,</span> <span class="n">single_step_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;Dense&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dense</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">single_step_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;Dense&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dense</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">single_step_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="RNN">
<h4>RNN<a class="headerlink" href="#RNN" title="Enlazar permanentemente con este título">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">wide_window</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span>
    <span class="n">input_width</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">label_width</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">lstm_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="c1"># Shape [batch, time, features] =&gt; [batch, time, lstm_units]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="c1"># Shape =&gt; [batch, time, features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">num_features</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">lstm_model</span><span class="p">,</span> <span class="n">wide_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">wide_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span> <span class="n">wide_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Advanced:-Residual-connections">
<h4>Advanced: Residual connections<a class="headerlink" href="#Advanced:-Residual-connections" title="Enlazar permanentemente con este título">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Baseline</span></code> model from earlier took advantage of the fact that the sequence doesn’t change drastically from time step to time step. Every model trained in this tutorial so far was randomly initialized, and then had to learn that the output is a a small change from the previous time step.</p>
<p>While you can get around this issue with careful initialization, it’s simpler to build this into the model structure.</p>
<p>It’s common in time series analysis to build models that instead of predicting the next value, predict how the value will change in the next timestep. Similarly, “Residual networks” or “ResNets” in deep learning refer to architectures where each layer adds to the model’s accumulating result.</p>
<p>That is how you take advantage of the knowledge that the change should be small.</p>
<p><img alt="A model with a residual connection" src="../../../../_images/residual.png" /></p>
<p>Essentially this initializes the model to match the <code class="docutils literal notranslate"><span class="pre">Baseline</span></code>. For this task it helps models converge faster, with slightly better performance.</p>
<p>This approach can be used in conjunction with any model discussed in this tutorial.</p>
<p>Here it is being applied to the LSTM model, note the use of the <code class="docutils literal notranslate"><span class="pre">tf.initializers.zeros</span></code> to ensure that the initial predicted changes are small, and don’t overpower the residual connection. There are no symmetry-breaking concerns for the gradients here, since the <code class="docutils literal notranslate"><span class="pre">zeros</span></code> are only used on the last layer.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">ResidualWrapper</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># The prediction for each timestep is the input</span>
    <span class="c1"># from the previous time step plus the delta</span>
    <span class="c1"># calculated by the model.</span>
    <span class="k">return</span> <span class="n">inputs</span> <span class="o">+</span> <span class="n">delta</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">residual_lstm</span> <span class="o">=</span> <span class="n">ResidualWrapper</span><span class="p">(</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
        <span class="n">num_features</span><span class="p">,</span>
        <span class="c1"># The predicted deltas should start small</span>
        <span class="c1"># So initialize the output layer with zeros</span>
        <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">zeros</span><span class="p">())</span>
<span class="p">]))</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">residual_lstm</span><span class="p">,</span> <span class="n">wide_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
<span class="n">val_performance</span><span class="p">[</span><span class="s1">&#39;Residual LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">residual_lstm</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">performance</span><span class="p">[</span><span class="s1">&#39;Residual LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">residual_lstm</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">wide_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h4>Performance<a class="headerlink" href="#id11" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Here is the overall performance for these multi-output models.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">performance</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;mean_absolute_error&#39;</span>
<span class="n">metric_index</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">metrics_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">)</span>
<span class="n">val_mae</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">metric_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val_performance</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">metric_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">performance</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.17</span><span class="p">,</span> <span class="n">val_mae</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.17</span><span class="p">,</span> <span class="n">test_mae</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">performance</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
           <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;MAE (average over all outputs)&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">performance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s1">15s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The above performances are averaged across all model outputs.</p>
</div>
</div>
</div>
<div class="section" id="Multi-step-models">
<h2>Multi-step models<a class="headerlink" href="#Multi-step-models" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Both the single-output and multiple-output models in the previous sections made <strong>single time step predictions</strong>, 1h into the future.</p>
<p>This section looks at how to expand these models to make <strong>multiple time step predictions</strong>.</p>
<p>In a multi-step prediction, the model needs to learn to predict a range of future values. Thus, unlike a single step model, where only a single future point is predicted, a multi-step model predicts a sequence of the future values.</p>
<p>There are two rough approaches to this:</p>
<ol class="arabic simple">
<li><p>Single shot predictions where the entire time series is predicted at once.</p></li>
<li><p>Autoregressive predictions where the model only makes single step predictions and its output is fed back as its input.</p></li>
</ol>
<p>In this section all the models will predict <strong>all the features across all output time steps</strong>.</p>
<p>For the multi-step model, the training data again consists of hourly samples. However, here, the models will learn to predict 24h of the future, given 24h of the past.</p>
<p>Here is a <code class="docutils literal notranslate"><span class="pre">Window</span></code> object that generates these slices from the dataset:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">OUT_STEPS</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">multi_window</span> <span class="o">=</span> <span class="n">WindowGenerator</span><span class="p">(</span><span class="n">input_width</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                               <span class="n">label_width</span><span class="o">=</span><span class="n">OUT_STEPS</span><span class="p">,</span>
                               <span class="n">shift</span><span class="o">=</span><span class="n">OUT_STEPS</span><span class="p">)</span>

<span class="n">multi_window</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">multi_window</span>
</pre></div>
</div>
</div>
<div class="section" id="Baselines">
<h3>Baselines<a class="headerlink" href="#Baselines" title="Enlazar permanentemente con este título">¶</a></h3>
<p>A simple baseline for this task is to repeat the last input time step for the required number of output timesteps:</p>
<p><img alt="Repeat the last input, for each output step" src="../../../../_images/multistep_last.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">MultiStepLastBaseline</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">inputs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">OUT_STEPS</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">last_baseline</span> <span class="o">=</span> <span class="n">MultiStepLastBaseline</span><span class="p">()</span>
<span class="n">last_baseline</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">()])</span>

<span class="n">multi_val_performance</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">multi_performance</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">multi_val_performance</span><span class="p">[</span><span class="s1">&#39;Last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_baseline</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">multi_performance</span><span class="p">[</span><span class="s1">&#39;Last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_baseline</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">multi_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">last_baseline</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Since this task is to predict 24h given 24h another simple approach is to repeat the previous day, assuming tomorrow will be similar:</p>
<p><img alt="Repeat the previous day" src="../../../../_images/multistep_repeat.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">RepeatBaseline</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">inputs</span>

<span class="n">repeat_baseline</span> <span class="o">=</span> <span class="n">RepeatBaseline</span><span class="p">()</span>
<span class="n">repeat_baseline</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
                        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">()])</span>

<span class="n">multi_val_performance</span><span class="p">[</span><span class="s1">&#39;Repeat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_baseline</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">multi_performance</span><span class="p">[</span><span class="s1">&#39;Repeat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repeat_baseline</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">multi_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">repeat_baseline</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Single-shot-models">
<h3>Single-shot models<a class="headerlink" href="#Single-shot-models" title="Enlazar permanentemente con este título">¶</a></h3>
<p>One high level approach to this problem is use a “single-shot” model, where the model makes the entire sequence prediction in a single step.</p>
<p>This can be implemented efficiently as a <code class="docutils literal notranslate"><span class="pre">layers.Dense</span></code> with <code class="docutils literal notranslate"><span class="pre">OUT_STEPS*features</span></code> output units. The model just needs to reshape that output to the required <code class="docutils literal notranslate"><span class="pre">(OUTPUT_STEPS,</span> <span class="pre">features)</span></code>.</p>
<div class="section" id="Linear">
<h4>Linear<a class="headerlink" href="#Linear" title="Enlazar permanentemente con este título">¶</a></h4>
<p>A simple linear model based on the last input time step does better than either baseline, but is underpowered. The model needs to predict <code class="docutils literal notranslate"><span class="pre">OUTPUT_STEPS</span></code> time steps, from a single input time step with a linear projection. It can only capture a low-dimensional slice of the behavior, likely based mainly on the time of day and time of year.</p>
<p><img alt="Predct all timesteps from the last time-step" src="../../../../_images/multistep_dense.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">multi_linear_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="c1"># Take the last time-step.</span>
    <span class="c1"># Shape [batch, time, features] =&gt; [batch, 1, features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]),</span>
    <span class="c1"># Shape =&gt; [batch, 1, out_steps*features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">OUT_STEPS</span><span class="o">*</span><span class="n">num_features</span><span class="p">,</span>
                          <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">zeros</span><span class="p">()),</span>
    <span class="c1"># Shape =&gt; [batch, out_steps, features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="n">OUT_STEPS</span><span class="p">,</span> <span class="n">num_features</span><span class="p">])</span>
<span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">multi_linear_model</span><span class="p">,</span> <span class="n">multi_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
<span class="n">multi_val_performance</span><span class="p">[</span><span class="s1">&#39;Linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_linear_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">multi_performance</span><span class="p">[</span><span class="s1">&#39;Linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_linear_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">multi_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">multi_linear_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id12">
<h4>Dense<a class="headerlink" href="#id12" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Adding a <code class="docutils literal notranslate"><span class="pre">layers.Dense</span></code> between the input and output gives the linear model more power, but is still only based on a single input timestep.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">multi_dense_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="c1"># Take the last time step.</span>
    <span class="c1"># Shape [batch, time, features] =&gt; [batch, 1, features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]),</span>
    <span class="c1"># Shape =&gt; [batch, 1, dense_units]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="c1"># Shape =&gt; [batch, out_steps*features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">OUT_STEPS</span><span class="o">*</span><span class="n">num_features</span><span class="p">,</span>
                          <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">zeros</span><span class="p">()),</span>
    <span class="c1"># Shape =&gt; [batch, out_steps, features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="n">OUT_STEPS</span><span class="p">,</span> <span class="n">num_features</span><span class="p">])</span>
<span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">multi_dense_model</span><span class="p">,</span> <span class="n">multi_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>
<span class="n">multi_val_performance</span><span class="p">[</span><span class="s1">&#39;Dense&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_dense_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">multi_performance</span><span class="p">[</span><span class="s1">&#39;Dense&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_dense_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">multi_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">multi_dense_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="CNN">
<h4>CNN<a class="headerlink" href="#CNN" title="Enlazar permanentemente con este título">¶</a></h4>
<p>A convolutional model makes predictions based on a fixed-width history, which may lead to better performance than the dense model since it can see how things are changing over time:</p>
<p><img alt="A convolutional model sees how things change over time" src="../../../../_images/multistep_conv.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">CONV_WIDTH</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">multi_conv_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="c1"># Shape [batch, time, features] =&gt; [batch, CONV_WIDTH, features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="n">CONV_WIDTH</span><span class="p">:,</span> <span class="p">:]),</span>
    <span class="c1"># Shape =&gt; [batch, 1, conv_units]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="n">CONV_WIDTH</span><span class="p">)),</span>
    <span class="c1"># Shape =&gt; [batch, 1,  out_steps*features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">OUT_STEPS</span><span class="o">*</span><span class="n">num_features</span><span class="p">,</span>
                          <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">zeros</span><span class="p">()),</span>
    <span class="c1"># Shape =&gt; [batch, out_steps, features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="n">OUT_STEPS</span><span class="p">,</span> <span class="n">num_features</span><span class="p">])</span>
<span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">multi_conv_model</span><span class="p">,</span> <span class="n">multi_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>

<span class="n">multi_val_performance</span><span class="p">[</span><span class="s1">&#39;Conv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_conv_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">multi_performance</span><span class="p">[</span><span class="s1">&#39;Conv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_conv_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">multi_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">multi_conv_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id13">
<h4>RNN<a class="headerlink" href="#id13" title="Enlazar permanentemente con este título">¶</a></h4>
<p>A recurrent model can learn to use a long history of inputs, if it’s relevant to the predictions the model is making. Here the model will accumulate internal state for 24h, before making a single prediction for the next 24h.</p>
<p>In this single-shot format, the LSTM only needs to produce an output at the last time step, so set <code class="docutils literal notranslate"><span class="pre">return_sequences=False</span></code>.</p>
<p><img alt="The lstm accumulates state over the input window, and makes a single prediction for the next 24h" src="../../../../_images/multistep_lstm.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">multi_lstm_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="c1"># Shape [batch, time, features] =&gt; [batch, lstm_units]</span>
    <span class="c1"># Adding more `lstm_units` just overfits more quickly.</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="c1"># Shape =&gt; [batch, out_steps*features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">OUT_STEPS</span><span class="o">*</span><span class="n">num_features</span><span class="p">,</span>
                          <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">zeros</span><span class="p">()),</span>
    <span class="c1"># Shape =&gt; [batch, out_steps, features]</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="n">OUT_STEPS</span><span class="p">,</span> <span class="n">num_features</span><span class="p">])</span>
<span class="p">])</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">multi_lstm_model</span><span class="p">,</span> <span class="n">multi_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>

<span class="n">multi_val_performance</span><span class="p">[</span><span class="s1">&#39;LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_lstm_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">multi_performance</span><span class="p">[</span><span class="s1">&#39;LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_lstm_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">multi_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">multi_lstm_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Advanced:-Autoregressive-model">
<h3>Advanced: Autoregressive model<a class="headerlink" href="#Advanced:-Autoregressive-model" title="Enlazar permanentemente con este título">¶</a></h3>
<p>The above models all predict the entire output sequence in a single step.</p>
<p>In some cases it may be helpful for the model to decompose this prediction into individual time steps. Then each model’s output can be fed back into itself at each step and predictions can be made conditioned on the previous one, like in the classic <a class="reference external" href="https://arxiv.org/abs/1308.0850">Generating Sequences With Recurrent Neural Networks</a>.</p>
<p>One clear advantage to this style of model is that it can be set up to produce output with a varying length.</p>
<p>You could take any of the single-step multi-output models trained in the first half of this tutorial and run in an autoregressive feedback loop, but here you’ll focus on building a model that’s been explicitly trained to do that.</p>
<p><img alt="Feedback a model’s output to its input" src="../../../../_images/multistep_autoregressive.png" /></p>
<div class="section" id="id14">
<h4>RNN<a class="headerlink" href="#id14" title="Enlazar permanentemente con este título">¶</a></h4>
<p>This tutorial only builds an autoregressive RNN model, but this pattern could be applied to any model that was designed to output a single timestep.</p>
<p>The model will have the same basic form as the single-step <code class="docutils literal notranslate"><span class="pre">LSTM</span></code> models: An <code class="docutils literal notranslate"><span class="pre">LSTM</span></code> followed by a <code class="docutils literal notranslate"><span class="pre">layers.Dense</span></code> that converts the <code class="docutils literal notranslate"><span class="pre">LSTM</span></code> outputs to model predictions.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">layers.LSTM</span></code> is a <code class="docutils literal notranslate"><span class="pre">layers.LSTMCell</span></code> wrapped in the higher level <code class="docutils literal notranslate"><span class="pre">layers.RNN</span></code> that manages the state and sequence results for you (See <a class="reference external" href="https://www.tensorflow.org/guide/keras/rnn">Keras RNNs</a> for details).</p>
<p>In this case the model has to manually manage the inputs for each step so it uses <code class="docutils literal notranslate"><span class="pre">layers.LSTMCell</span></code> directly for the lower level, single time step interface.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">FeedBack</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">out_steps</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">out_steps</span> <span class="o">=</span> <span class="n">out_steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lstm_cell</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTMCell</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="c1"># Also wrap the LSTMCell in an RNN to simplify the `warmup` method.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lstm_rnn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">RNN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lstm_cell</span><span class="p">,</span> <span class="n">return_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">feedback_model</span> <span class="o">=</span> <span class="n">FeedBack</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">out_steps</span><span class="o">=</span><span class="n">OUT_STEPS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The first method this model needs is a <code class="docutils literal notranslate"><span class="pre">warmup</span></code> method to initialize its internal state based on the inputs. Once trained this state will capture the relevant parts of the input history. This is equivalent to the single-step <code class="docutils literal notranslate"><span class="pre">LSTM</span></code> model from earlier:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">warmup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
  <span class="c1"># inputs.shape =&gt; (batch, time, features)</span>
  <span class="c1"># x.shape =&gt; (batch, lstm_units)</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_rnn</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

  <span class="c1"># predictions.shape =&gt; (batch, features)</span>
  <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">state</span>

<span class="n">FeedBack</span><span class="o">.</span><span class="n">warmup</span> <span class="o">=</span> <span class="n">warmup</span>
</pre></div>
</div>
</div>
<p>This method returns a single time-step prediction, and the internal state of the LSTM:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prediction</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">feedback_model</span><span class="o">.</span><span class="n">warmup</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">prediction</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<p>With the <code class="docutils literal notranslate"><span class="pre">RNN</span></code>’s state, and an initial prediction you can now continue iterating the model feeding the predictions at each step back as the input.</p>
<p>The simplest approach to collecting the output predictions is to use a python list, and <code class="docutils literal notranslate"><span class="pre">tf.stack</span></code> after the loop.</p>
<p>Note: Stacking a python list like this only works with eager-execution, using <code class="docutils literal notranslate"><span class="pre">Model.compile(...,</span> <span class="pre">run_eagerly=True)</span></code> for training, or with a fixed length output. For a dynamic output length you would need to use a <code class="docutils literal notranslate"><span class="pre">tf.TensorArray</span></code> instead of a python list, and <code class="docutils literal notranslate"><span class="pre">tf.range</span></code> instead of the python <code class="docutils literal notranslate"><span class="pre">range</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="c1"># Use a TensorArray to capture dynamically unrolled outputs.</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="c1"># Initialize the lstm state</span>
  <span class="n">prediction</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

  <span class="c1"># Insert the first prediction</span>
  <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>

  <span class="c1"># Run the rest of the prediction steps</span>
  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_steps</span><span class="p">):</span>
    <span class="c1"># Use the last prediction as input.</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">prediction</span>
    <span class="c1"># Execute one lstm step.</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm_cell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                              <span class="n">training</span><span class="o">=</span><span class="n">training</span><span class="p">)</span>
    <span class="c1"># Convert the lstm output to a prediction.</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dense</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># Add the prediction to the output</span>
    <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>

  <span class="c1"># predictions.shape =&gt; (time, batch, features)</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
  <span class="c1"># predictions.shape =&gt; (batch, time, features)</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">predictions</span>

<span class="n">FeedBack</span><span class="o">.</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span>
</pre></div>
</div>
</div>
<p>Test run this model on the example inputs:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Output shape (batch, time, features): &#39;</span><span class="p">,</span> <span class="n">feedback_model</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">example</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now train the model:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">history</span> <span class="o">=</span> <span class="n">compile_and_fit</span><span class="p">(</span><span class="n">feedback_model</span><span class="p">,</span> <span class="n">multi_window</span><span class="p">)</span>

<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>

<span class="n">multi_val_performance</span><span class="p">[</span><span class="s1">&#39;AR LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feedback_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
<span class="n">multi_performance</span><span class="p">[</span><span class="s1">&#39;AR LSTM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feedback_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">multi_window</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">multi_window</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">feedback_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id15">
<h3>Performance<a class="headerlink" href="#id15" title="Enlazar permanentemente con este título">¶</a></h3>
<p>There are clearly diminishing returns as a function of model complexity on this problem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">multi_performance</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.3</span>


<span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;mean_absolute_error&#39;</span>
<span class="n">metric_index</span> <span class="o">=</span> <span class="n">lstm_model</span><span class="o">.</span><span class="n">metrics_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">)</span>
<span class="n">val_mae</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">metric_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">multi_val_performance</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">metric_index</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">multi_performance</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.17</span><span class="p">,</span> <span class="n">val_mae</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Validation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.17</span><span class="p">,</span> <span class="n">test_mae</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">multi_performance</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
           <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;MAE (average over all times and outputs)&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The metrics for the multi-output models in the first half of this tutorial show the performance averaged across all output features. These performances similar but also averaged across output timesteps.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">multi_performance</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s1">8s</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The gains achieved going from a dense model to convolutional and recurrent models are only a few percent (if any), and the autoregressive model performed clearly worse. So these more complex approaches may not be worth while on <strong>this</strong> problem, but there was no way to know without trying, and these models could be helpful for <strong>your</strong> problem.</p>
</div>
</div>
<div class="section" id="Next-steps">
<h2>Next steps<a class="headerlink" href="#Next-steps" title="Enlazar permanentemente con este título">¶</a></h2>
<p>This tutorial was a quick introduction to time series forecasting using TensorFlow.</p>
<ul class="simple">
<li><p>For further understanding, see:</p>
<ul>
<li><p>Chapter 15 of <a class="reference external" href="https://www.oreilly.com/library/view/hands-on-machine-learning/9781492032632/">Hands-on Machine Learning with Scikit-Learn, Keras, and TensorFlow</a>, 2nd Edition</p></li>
<li><p>Chapter 6 of <a class="reference external" href="https://www.manning.com/books/deep-learning-with-python">Deep Learning with Python</a>.</p></li>
<li><p>Lesson 8 of <a class="reference external" href="https://www.udacity.com/course/intro-to-tensorflow-for-deep-learning--ud187">Udacity’s intro to TensorFlow for deep learning</a>, and the <a class="reference external" href="https://github.com/tensorflow/examples/tree/master/courses/udacity_intro_to_tensorflow_for_deep_learning">exercise notebooks</a></p></li>
</ul>
</li>
<li><p>Also remember that you can implement any <a class="reference external" href="https://otexts.com/fpp2/index.html">classical time series model</a> in TensorFlow, this tutorial just focuses on TensorFlow’s built-in functionality.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Derechos de autor 2019, Juan D. Velasquez.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>