

<!DOCTYPE html>
<html class="writer-html5" lang="es" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Integrated gradients &mdash; documentación de --- Cursos --- - </title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script src="../../../../_static/translations.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> --- Cursos ---
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Configuración</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">Instalación de Vagrant y Docker</a></li>
</ul>
<p class="caption"><span class="caption-text">Cursos de Pregrado</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../fundamentos-de-analitica/index.html">Fundamentos de Analítica</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html">Redes Neuronales Artificiales y Algoritmos Bioinspirados</a></li>
</ul>
<p class="caption"><span class="caption-text">Cursos de Posgrado</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica-de-grandes-datos/index.html">Analítica de Grandes Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica-predictiva/index.html">Analítica Predictiva</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ciencia-de-los-datos/index.html">Ciencia de los Datos Aplicada</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../productos-de-datos/index.html">Productos de Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica_avanzada/index.html">Analítica Avanzada</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">--- Cursos ---</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Integrated gradients</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../_sources/notebooks/tensorflow/tutorials/Interpretability/1-01_integrated_gradients.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Integrated-gradients">
<h1>Integrated gradients<a class="headerlink" href="#Integrated-gradients" title="Enlazar permanentemente con este título">¶</a></h1>
<table class="tfo-notebook-buttons" align="left"><td><p><a href="#id1"><span class="problematic" id="id2">|</span></a>cf08c5f45f2640288b28a2313a7f020c|View on TensorFlow.org</p>
</td><td><p><a href="#id3"><span class="problematic" id="id4">|</span></a>c7698c5cc8fc4f11ace3b9d8a7c2f6e4|Run in Google Colab</p>
</td><td><p><a href="#id5"><span class="problematic" id="id6">|</span></a>fc14dc49036240ad93a21e34bd08fd42|View on GitHub</p>
</td><td><p><a href="#id7"><span class="problematic" id="id8">|</span></a>a8e603a5404a4a82b915c22aafd62884|Download notebook</p>
</td><td><p><a href="#id9"><span class="problematic" id="id10">|</span></a>9f27d1f3e47d4d2980021e5f7b9cfee3|See TF Hub model</p>
</td></table><p>This tutorial demonstrates how to implement <strong>Integrated Gradients (IG)</strong>, an <a class="reference external" href="https://en.wikipedia.org/wiki/Explainable_artificial_intelligence">Explainable AI</a> technique introduced in the paper <a class="reference external" href="https://arxiv.org/abs/1703.01365">Axiomatic Attribution for Deep Networks</a>. IG aims to explain the relationship between a model’s predictions in terms of its features. It has many use cases including understanding feature importances, identifying data skew, and debugging model performance.</p>
<p>IG has become a popular interpretability technique due to its broad applicability to any differentiable model (e.g. images, text, structured data), ease of implementation, theoretical justifications, and computational efficiency relative to alternative approaches that allows it to scale to large networks and feature spaces such as images.</p>
<p>In this tutorial, you will walk through an implementation of IG step-by-step to understand the pixel feature importances of an image classifier. As an example, consider this <a class="reference external" href="https://commons.wikimedia.org/wiki/File:San_Francisco_fireboat_showing_off.jpg">image</a> of a fireboat spraying jets of water. You would classify this image as a fireboat and might highlight the pixels making up the boat and water cannons as being important to your decision. Your model will also classify this image as a
fireboat later on in this tutorial; however, does it highlight the same pixels as important when explaining its decision?</p>
<p>In the images below titled “IG Attribution Mask” and “Original + IG Mask Overlay” you can see that your model instead highlights (in purple) the pixels comprising the boat’s water cannons and jets of water as being more important than the boat itself to its decision. How will your model generalize to new fireboats? What about fireboats without water jets? Read on to learn more about how IG works and how to apply IG to your models to better understand the relationship between their predictions
and underlying features.</p>
<p><img alt="Output Image 1" src="../../../../_images/IG_fireboat.png" /></p>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_hub</span> <span class="k">as</span> <span class="nn">hub</span>
</pre></div>
</div>
</div>
<div class="section" id="Download-a-pretrained-image-classifier-from-TF-Hub">
<h3>Download a pretrained image classifier from TF-Hub<a class="headerlink" href="#Download-a-pretrained-image-classifier-from-TF-Hub" title="Enlazar permanentemente con este título">¶</a></h3>
<p>IG can be applied to any differentiable model. In the spirit of the original paper, you will use a pre-trained version of the same model, Inception V1, which you will download from <a class="reference external" href="https://tfhub.dev/google/imagenet/inception_v1/classification/4">TensorFlow Hub</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">hub</span><span class="o">.</span><span class="n">KerasLayer</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inception_v1&#39;</span><span class="p">,</span>
        <span class="n">handle</span><span class="o">=</span><span class="s1">&#39;https://tfhub.dev/google/imagenet/inception_v1/classification/4&#39;</span><span class="p">,</span>
        <span class="n">trainable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">build</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>From the module page, you need to keep in mind the following about Inception V1:</p>
<p><strong>Inputs</strong>: The expected input shape for the model is <code class="docutils literal notranslate"><span class="pre">(None,</span> <span class="pre">224,</span> <span class="pre">224,</span> <span class="pre">3)</span></code>. This is a dense 4D tensor of dtype float32 and shape <code class="docutils literal notranslate"><span class="pre">(batch_size,</span> <span class="pre">height,</span> <span class="pre">width,</span> <span class="pre">RGB</span> <span class="pre">channels)</span></code> whose elements are RGB color values of pixels normalized to the range [0, 1]. The first element is <code class="docutils literal notranslate"><span class="pre">None</span></code> to indicate that the model can take any integer batch size.</p>
<p><strong>Outputs</strong>: A <code class="docutils literal notranslate"><span class="pre">tf.Tensor</span></code> of logits in the shape of <code class="docutils literal notranslate"><span class="pre">(batch_size,</span> <span class="pre">1001)</span></code>. Each row represents the model’s predicted score for each of 1,001 classes from ImageNet. For the model’s top predicted class index you can use <code class="docutils literal notranslate"><span class="pre">tf.argmax(predictions,</span> <span class="pre">axis=-1)</span></code>. Furthermore, you can also convert the model’s logit output to predicted probabilities across all classes using <code class="docutils literal notranslate"><span class="pre">tf.nn.softmax(predictions,</span> <span class="pre">axis=-1)</span></code> to quantify the model’s uncertainty as well as explore similar predicted classes for
debugging.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">load_imagenet_labels</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
  <span class="n">labels_file</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="s1">&#39;ImageNetLabels.txt&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">labels_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">imagenet_labels</span> <span class="o">=</span> <span class="n">load_imagenet_labels</span><span class="p">(</span><span class="s1">&#39;https://storage.googleapis.com/download.tensorflow.org/data/ImageNetLabels.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Load-and-preprocess-images-with-tf.image">
<h3>Load and preprocess images with <code class="docutils literal notranslate"><span class="pre">tf.image</span></code><a class="headerlink" href="#Load-and-preprocess-images-with-tf.image" title="Enlazar permanentemente con este título">¶</a></h3>
<p>You will illustrate IG using two images from <a class="reference external" href="https://commons.wikimedia.org/wiki/Main_Page">Wikimedia Commons</a>: a <a class="reference external" href="https://commons.wikimedia.org/wiki/File:San_Francisco_fireboat_showing_off.jpg">Fireboat</a>, and a <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Giant_Panda_2.JPG">Giant Panda</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">read_image</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">convert_image_dtype</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_with_pad</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target_height</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">target_width</span><span class="o">=</span><span class="mi">224</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">image</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">img_url</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Fireboat&#39;</span><span class="p">:</span> <span class="s1">&#39;http://storage.googleapis.com/download.tensorflow.org/example_images/San_Francisco_fireboat_showing_off.jpg&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Giant Panda&#39;</span><span class="p">:</span> <span class="s1">&#39;http://storage.googleapis.com/download.tensorflow.org/example_images/Giant_Panda_2.jpeg&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">img_paths</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="ow">in</span> <span class="n">img_url</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">img_name_tensors</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">read_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">img_path</span><span class="p">)</span> <span class="ow">in</span> <span class="n">img_paths</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">img_tensors</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">img_name_tensors</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
  <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensors</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
  <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Classify-images">
<h3>Classify images<a class="headerlink" href="#Classify-images" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Let’s start by classifying these images and displaying the top 3 most confident predictions. Following is a utility function to retrieve the top k predicted labels and probabilities.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">top_k_predictions</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
  <span class="n">image_batch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image_batch</span><span class="p">)</span>
  <span class="n">probs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">top_probs</span><span class="p">,</span> <span class="n">top_idxs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">top_k</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
  <span class="n">top_labels</span> <span class="o">=</span> <span class="n">imagenet_labels</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">top_idxs</span><span class="p">)]</span>
  <span class="k">return</span> <span class="n">top_labels</span><span class="p">,</span> <span class="n">top_probs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">img_tensor</span><span class="p">)</span> <span class="ow">in</span> <span class="n">img_name_tensors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

  <span class="n">pred_label</span><span class="p">,</span> <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">top_k_predictions</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pred_label</span><span class="p">,</span> <span class="n">pred_prob</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">prob</span><span class="si">:</span><span class="s1">0.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Calculate-Integrated-Gradients">
<h2>Calculate Integrated Gradients<a class="headerlink" href="#Calculate-Integrated-Gradients" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Your model, Inception V1, is a learned function that describes a mapping between your input feature space, image pixel values, and an output space defined by ImageNet class probability values between 0 and 1. Early interpretability methods for neural networks assigned feature importance scores using gradients, which tell you which pixels have the steepest local relative to your model’s prediction at a given point along your model’s prediction function. However, gradients only describe <em>local</em>
changes in your model’s prediction function with respect to pixel values and do not fully describe your entire model prediction function. As your model fully “learns” the relationship between the range of an individual pixel and the correct ImageNet class, the gradient for this pixel will <em>saturate</em>, meaning become increasingly small and even go to zero. Consider the simple model function below:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A simplified model function.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">interpolated_path</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A straight line path.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Gradients saturate over F(x)&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Gradients &gt; 0 = </span><span class="se">\n</span><span class="s1"> x is important&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s1">&#39;Gradients = 0 </span><span class="se">\n</span><span class="s1"> x not important&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F(x) - model true class predicted probability&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x - (pixel value)&#39;</span><span class="p">)</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">interpolated_path</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;IG intuition&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;Accumulate gradients along path&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;F(x) - model true class predicted probability&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x - (pixel value)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Baseline&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
             <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Input&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
             <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p><strong>left</strong>: Your model’s gradients for pixel <code class="docutils literal notranslate"><span class="pre">x</span></code> are positive between 0.0 and 0.8 but go to 0.0 between 0.8 and 1.0. Pixel <code class="docutils literal notranslate"><span class="pre">x</span></code> clearly has a significant impact on pushing your model toward 80% predicted probability on the true class. <em>Does it make sense that pixel ``x``’s importance is small or discontinuous?</em></p></li>
<li><p><strong>right</strong>: The intuition behind IG is to accumulate pixel <code class="docutils literal notranslate"><span class="pre">x</span></code>’s local gradients and attribute its importance as a score for how much it adds or subtracts to your model’s overall output class probability. You can break down and compute IG in 3 parts:</p>
<ol class="arabic simple">
<li><p>interpolate small steps along a straight line in the feature space between 0 (a baseline or starting point) and 1 (input pixel’s value)</p></li>
<li><p>compute gradients at each step between your model’s predictions with respect to each step</p></li>
<li><p>approximate the integral between your baseline and input by accumulating (cumulative average) these local gradients.</p></li>
</ol>
</li>
</ul>
<p>To reinforce this intuition, you will walk through these 3 parts by applying IG to the example “Fireboat” image below.</p>
<div class="section" id="Establish-a-baseline">
<h3>Establish a baseline<a class="headerlink" href="#Establish-a-baseline" title="Enlazar permanentemente con este título">¶</a></h3>
<p>A baseline is an input image used as a starting point for calculating feature importance. Intuitively, you can think of the baseline’s explanatory role as representing the impact of the absence of each pixel on the “Fireboat” prediction to contrast with its impact of each pixel on the “Fireboat” prediction when present in the input image. As a result, the choice of the baseline plays a central role in interpreting and visualizing pixel feature importances. For additional discussion of baseline
selection, see the resources in the “Next steps” section at the bottom of this tutorial. Here, you will use a black image whose pixel values are all zero.</p>
<p>Other choices you could experiment with include an all white image, or a random image, which you can create with <code class="docutils literal notranslate"><span class="pre">tf.random.uniform(shape=(224,224,3),</span> <span class="pre">minval=0.0,</span> <span class="pre">maxval=1.0)</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">baseline</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Baseline&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Unpack-formulas-into-code">
<h3>Unpack formulas into code<a class="headerlink" href="#Unpack-formulas-into-code" title="Enlazar permanentemente con este título">¶</a></h3>
<p>The formula for Integrated Gradients is as follows:</p>
<p><span class="math notranslate nohighlight">\(IntegratedGradients_{i}(x) ::= (x_{i} - x'_{i})\times\int_{\alpha=0}^1\frac{\partial F(x'+\alpha \times (x - x'))}{\partial x_i}{d\alpha}\)</span></p>
<p>where:</p>
<div class="line-block">
<div class="line"><span class="math notranslate nohighlight">\(_{i}\)</span> = feature</div>
<div class="line"><span class="math notranslate nohighlight">\(x\)</span> = input</div>
<div class="line"><span class="math notranslate nohighlight">\(x'\)</span> = baseline</div>
<div class="line"><span class="math notranslate nohighlight">\(\alpha\)</span> = interpolation constant to perturb features by</div>
</div>
<p>In practice, computing a definite integral is not always numerically possible and can be computationally costly, so you compute the following numerical approximation:</p>
<p><span class="math notranslate nohighlight">\(IntegratedGrads^{approx}_{i}(x)::=(x_{i}-x'_{i})\times\sum_{k=1}^{m}\frac{\partial F(x' + \frac{k}{m}\times(x - x'))}{\partial x_{i}} \times \frac{1}{m}\)</span></p>
<p>where:</p>
<div class="line-block">
<div class="line"><span class="math notranslate nohighlight">\(_{i}\)</span> = feature (individual pixel)</div>
<div class="line"><span class="math notranslate nohighlight">\(x\)</span> = input (image tensor)</div>
<div class="line"><span class="math notranslate nohighlight">\(x'\)</span> = baseline (image tensor)</div>
<div class="line"><span class="math notranslate nohighlight">\(k\)</span> = scaled feature perturbation constant</div>
<div class="line"><span class="math notranslate nohighlight">\(m\)</span> = number of steps in the Riemann sum approximation of the integral</div>
<div class="line"><span class="math notranslate nohighlight">\((x_{i}-x'_{i})\)</span> = a term for the difference from the baseline. This is necessary to scale the integrated gradients and keep them in terms of the original image. The path from the baseline image to the input is in pixel space. Since with IG you are integrating in a straight line (linear transformation) this ends up being roughly equivalent to the integral term of the derivative of the interpolated image function with respect to <span class="math notranslate nohighlight">\(\alpha\)</span> with enough steps. The integral sums each
pixel’s gradient times the change in the pixel along the path. It’s simpler to implement this integration as uniform steps from one image to the other, substituting <span class="math notranslate nohighlight">\(x := (x' + \alpha(x-x'))\)</span>. So the change of variables gives <span class="math notranslate nohighlight">\(dx = (x-x')d\alpha\)</span>. The <span class="math notranslate nohighlight">\((x-x')\)</span> term is constant and is factored out of the integral.</div>
</div>
</div>
<div class="section" id="Interpolate-images">
<h3>Interpolate images<a class="headerlink" href="#Interpolate-images" title="Enlazar permanentemente con este título">¶</a></h3>
<p><span class="math notranslate nohighlight">\(IntegratedGrads^{approx}_{i}(x)::=(x_{i}-x'_{i})\times\sum_{k=1}^{m}\frac{\partial F(\overbrace{x' + \frac{k}{m}\times(x - x')}^\text{interpolate m images at k intervals})}{\partial x_{i}} \times \frac{1}{m}\)</span></p>
<p>First, you will generate a <a class="reference external" href="https://en.wikipedia.org/wiki/Linear_interpolation">linear interpolation</a> between the baseline and the original image. You can think of interpolated images as small steps in the feature space between your baseline and input, represented by <span class="math notranslate nohighlight">\(\alpha\)</span> in the original equation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">m_steps</span><span class="o">=</span><span class="mi">50</span>
<span class="n">alphas</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">m_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Generate m_steps intervals for integral_approximation() below.</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">interpolate_images</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span>
                       <span class="n">image</span><span class="p">,</span>
                       <span class="n">alphas</span><span class="p">):</span>
  <span class="n">alphas_x</span> <span class="o">=</span> <span class="n">alphas</span><span class="p">[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
  <span class="n">baseline_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">input_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">delta</span> <span class="o">=</span> <span class="n">input_x</span> <span class="o">-</span> <span class="n">baseline_x</span>
  <span class="n">images</span> <span class="o">=</span> <span class="n">baseline_x</span> <span class="o">+</span>  <span class="n">alphas_x</span> <span class="o">*</span> <span class="n">delta</span>
  <span class="k">return</span> <span class="n">images</span>
</pre></div>
</div>
</div>
<p>Let’s use the above function to generate interpolated images along a linear path at alpha intervals between a black baseline image and the example “Fireboat” image.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">interpolated_images</span> <span class="o">=</span> <span class="n">interpolate_images</span><span class="p">(</span>
    <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span>
    <span class="n">image</span><span class="o">=</span><span class="n">img_name_tensors</span><span class="p">[</span><span class="s1">&#39;Fireboat&#39;</span><span class="p">],</span>
    <span class="n">alphas</span><span class="o">=</span><span class="n">alphas</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s visualize the interpolated images. Note: another way of thinking about the <span class="math notranslate nohighlight">\(\alpha\)</span> constant is that it is consistently increasing each interpolated image’s intensity.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alphas</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">10</span><span class="p">],</span> <span class="n">interpolated_images</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">10</span><span class="p">]):</span>
  <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alphas</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">10</span><span class="p">]),</span> <span class="n">i</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;alpha: </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Compute-gradients">
<h3>Compute gradients<a class="headerlink" href="#Compute-gradients" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Now let’s take a look at how to calculate gradients in order to measure the relationship between changes to a feature and changes in the model’s predictions. In the case of images, the gradient tells us which pixels have the strongest effect on the models predicted class probabilities.</p>
<p><span class="math notranslate nohighlight">\(IntegratedGrads^{approx}_{i}(x)::=(x_{i}-x'_{i})\times\sum_{k=1}^{m}\frac{\overbrace{\partial F(\text{interpolated images})}^\text{compute gradients}}{\partial x_{i}} \times \frac{1}{m}\)</span></p>
<div class="line-block">
<div class="line">where:</div>
<div class="line"><span class="math notranslate nohighlight">\(F()\)</span> = your model’s prediction function</div>
<div class="line"><span class="math notranslate nohighlight">\(\frac{\partial{F}}{\partial{x_i}}\)</span> = gradient (vector of partial derivatives <span class="math notranslate nohighlight">\(\partial\)</span>) of your model F’s prediction function relative to each feature <span class="math notranslate nohighlight">\(x_i\)</span></div>
</div>
<p>TensorFlow makes computing gradients easy for you with a <code class="docutils literal notranslate"><span class="pre">`tf.GradientTape</span></code> &lt;<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/GradientTape">https://www.tensorflow.org/api_docs/python/tf/GradientTape</a>&gt;`__.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">compute_gradients</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">target_class_idx</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">tape</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">target_class_idx</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s compute the gradients for each image along the interpolation path with respect to the correct output. Recall that your model returns a <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">1001)</span></code> shaped <code class="docutils literal notranslate"><span class="pre">Tensor</span></code> with logits that you convert to predicted probabilities for each class. You need to pass the correct ImageNet target class index to the <code class="docutils literal notranslate"><span class="pre">compute_gradients</span></code> function for your image.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">path_gradients</span> <span class="o">=</span> <span class="n">compute_gradients</span><span class="p">(</span>
    <span class="n">images</span><span class="o">=</span><span class="n">interpolated_images</span><span class="p">,</span>
    <span class="n">target_class_idx</span><span class="o">=</span><span class="mi">555</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note the output shape of <code class="docutils literal notranslate"><span class="pre">(n_interpolated_images,</span> <span class="pre">img_height,</span> <span class="pre">img_width,</span> <span class="pre">RGB)</span></code>, which gives us the gradient for every pixel of every image along the interpolation path. You can think of these gradients as measuring the change in your model’s predictions for each small step in the feature space.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">path_gradients</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><strong>Visualizing gradient saturation</strong></p>
<p>Recall that the gradients you just calculated above describe <em>local</em> changes to your model’s predicted probability of “Fireboat” and can <em>saturate</em>.</p>
<p>These concepts are visualized using the gradients you calculated above in the 2 plots below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">interpolated_images</span><span class="p">)</span>
<span class="n">pred_proba</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="mi">555</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">pred_proba</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Target class predicted probability over alpha&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;model p(target class)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># Average across interpolation steps</span>
<span class="n">average_grads</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">path_gradients</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="c1"># Normalize gradients to 0 to 1 scale. E.g. (x - min(x))/(max(x)-min(x))</span>
<span class="n">average_grads_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_grads</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">average_grads</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">average_grads</span><span class="p">)</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">average_grads</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">average_grads_norm</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Average pixel gradients (normalized) over alpha&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average pixel gradients&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li><p><strong>left</strong>: This plot shows how your model’s confidence in the “Fireboat” class varies across alphas. Notice how the gradients, or slope of the line, largely flattens or saturates between 0.6 and 1.0 before settling at the final “Fireboat” predicted probability of about 40%.</p></li>
<li><p><strong>right</strong>: The right plot shows the average gradients magnitudes over alpha more directly. Note how the values sharply approach and even briefly dip below zero. In fact, your model “learns” the most from gradients at lower values of alpha before saturating. Intuitively, you can think of this as your model has learned the pixels e.g. water cannons to make the correct prediction, sending these pixels gradients to zero, but is still quite uncertain and focused on spurious bridge or water jet
pixels as the alpha values approach the original input image.</p></li>
</ul>
<p>To make sure these important water cannon pixels are reflected as important to the “Fireboat” prediction, you will continue on below to learn how to accumulate these gradients to accurately approximate how each pixel impacts your “Fireboat” predicted probability.</p>
</div>
<div class="section" id="Accumulate-gradients-(integral-approximation)">
<h3>Accumulate gradients (integral approximation)<a class="headerlink" href="#Accumulate-gradients-(integral-approximation)" title="Enlazar permanentemente con este título">¶</a></h3>
<p>There are many different ways you can go about computing the numerical approximation of an integral for IG with different tradeoffs in accuracy and convergence across varying functions. A popular class of methods is called <a class="reference external" href="https://en.wikipedia.org/wiki/Riemann_sum">Riemann sums</a>. Here, you will use the Trapezoidal rule (you can find additional code to explore different approximation methods at the end of this tutorial).</p>
<p><span class="math notranslate nohighlight">\(IntegratedGrads^{approx}_{i}(x)::=(x_{i}-x'_{i})\times \overbrace{\sum_{k=1}^{m}}^\text{Sum m local gradients} \text{gradients(interpolated images)} \times \overbrace{\frac{1}{m}}^\text{Divide by m steps}\)</span></p>
<p>From the equation, you can see you are summing over <code class="docutils literal notranslate"><span class="pre">m</span></code> gradients and dividing by <code class="docutils literal notranslate"><span class="pre">m</span></code> steps. You can implement the two operations together for part 3 as an <em>average of the local gradients of ``m`` interpolated predictions and input images</em>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">integral_approximation</span><span class="p">(</span><span class="n">gradients</span><span class="p">):</span>
  <span class="c1"># riemann_trapezoidal</span>
  <span class="n">grads</span> <span class="o">=</span> <span class="p">(</span><span class="n">gradients</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">gradients</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
  <span class="n">integrated_gradients</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">integrated_gradients</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">integral_approximation</span></code> function takes the gradients of the predicted probability of the target class with respect to the interpolated images between the baseline and the original image.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ig</span> <span class="o">=</span> <span class="n">integral_approximation</span><span class="p">(</span>
    <span class="n">gradients</span><span class="o">=</span><span class="n">path_gradients</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You can confirm averaging across the gradients of <code class="docutils literal notranslate"><span class="pre">m</span></code> interpolated images returns an integrated gradients tensor with the same shape as the original “Giant Panda” image.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">ig</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Putting-it-all-together">
<h3>Putting it all together<a class="headerlink" href="#Putting-it-all-together" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Now you will combine the 3 previous general parts together into an <code class="docutils literal notranslate"><span class="pre">IntegratedGradients</span></code> function and utilize a [&#64;tf.function](<a class="reference external" href="https://www.tensorflow.org/guide/function">https://www.tensorflow.org/guide/function</a>) decorator to compile it into a high performance callable TensorFlow graph. This is implemented as 5 smaller steps below:</p>
<p><span class="math notranslate nohighlight">\(IntegratedGrads^{approx}_{i}(x)::=\overbrace{(x_{i}-x'_{i})}^\text{5.}\times \overbrace{\sum_{k=1}^{m}}^\text{4.} \frac{\partial \overbrace{F(\overbrace{x' + \overbrace{\frac{k}{m}}^\text{1.}\times(x - x'))}^\text{2.}}^\text{3.}}{\partial x_{i}} \times \overbrace{\frac{1}{m}}^\text{4.}\)</span></p>
<ol class="arabic simple">
<li><p>Generate alphas <span class="math notranslate nohighlight">\(\alpha\)</span></p></li>
<li><p>Generate interpolated images = <span class="math notranslate nohighlight">\((x' + \frac{k}{m}\times(x - x'))\)</span></p></li>
<li><p>Compute gradients between model <span class="math notranslate nohighlight">\(F\)</span> output predictions with respect to input features = <span class="math notranslate nohighlight">\(\frac{\partial F(\text{interpolated path inputs})}{\partial x_{i}}\)</span></p></li>
<li><p>Integral approximation through averaging gradients = <span class="math notranslate nohighlight">\(\sum_{k=1}^m \text{gradients} \times \frac{1}{m}\)</span></p></li>
<li><p>Scale integrated gradients with respect to original image = <span class="math notranslate nohighlight">\((x_{i}-x'_{i}) \times \text{integrated gradients}\)</span>. The reason this step is necessary is to make sure that the attribution values accumulated across multiple interpolated images are in the same units and faithfully represent the pixel importances on the original image.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">integrated_gradients</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span>
                         <span class="n">image</span><span class="p">,</span>
                         <span class="n">target_class_idx</span><span class="p">,</span>
                         <span class="n">m_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                         <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
  <span class="c1"># 1. Generate alphas.</span>
  <span class="n">alphas</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">m_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

  <span class="c1"># Initialize TensorArray outside loop to collect gradients.</span>
  <span class="n">gradient_batches</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorArray</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">m_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

  <span class="c1"># Iterate alphas range and batch computation for speed, memory efficiency, and scaling to larger m_steps.</span>
  <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alphas</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="n">from_</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">from_</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alphas</span><span class="p">))</span>
    <span class="n">alpha_batch</span> <span class="o">=</span> <span class="n">alphas</span><span class="p">[</span><span class="n">from_</span><span class="p">:</span><span class="n">to</span><span class="p">]</span>

    <span class="c1"># 2. Generate interpolated inputs between baseline and input.</span>
    <span class="n">interpolated_path_input_batch</span> <span class="o">=</span> <span class="n">interpolate_images</span><span class="p">(</span><span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span>
                                                       <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
                                                       <span class="n">alphas</span><span class="o">=</span><span class="n">alpha_batch</span><span class="p">)</span>

    <span class="c1"># 3. Compute gradients between model outputs and interpolated inputs.</span>
    <span class="n">gradient_batch</span> <span class="o">=</span> <span class="n">compute_gradients</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="n">interpolated_path_input_batch</span><span class="p">,</span>
                                       <span class="n">target_class_idx</span><span class="o">=</span><span class="n">target_class_idx</span><span class="p">)</span>

    <span class="c1"># Write batch indices and gradients to extend TensorArray.</span>
    <span class="n">gradient_batches</span> <span class="o">=</span> <span class="n">gradient_batches</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">to</span><span class="p">),</span> <span class="n">gradient_batch</span><span class="p">)</span>

  <span class="c1"># Stack path gradients together row-wise into single tensor.</span>
  <span class="n">total_gradients</span> <span class="o">=</span> <span class="n">gradient_batches</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>

  <span class="c1"># 4. Integral approximation through averaging gradients.</span>
  <span class="n">avg_gradients</span> <span class="o">=</span> <span class="n">integral_approximation</span><span class="p">(</span><span class="n">gradients</span><span class="o">=</span><span class="n">total_gradients</span><span class="p">)</span>

  <span class="c1"># 5. Scale integrated gradients with respect to input.</span>
  <span class="n">integrated_gradients</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span> <span class="o">-</span> <span class="n">baseline</span><span class="p">)</span> <span class="o">*</span> <span class="n">avg_gradients</span>

  <span class="k">return</span> <span class="n">integrated_gradients</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ig_attributions</span> <span class="o">=</span> <span class="n">integrated_gradients</span><span class="p">(</span><span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span>
                                       <span class="n">image</span><span class="o">=</span><span class="n">img_name_tensors</span><span class="p">[</span><span class="s1">&#39;Fireboat&#39;</span><span class="p">],</span>
                                       <span class="n">target_class_idx</span><span class="o">=</span><span class="mi">555</span><span class="p">,</span>
                                       <span class="n">m_steps</span><span class="o">=</span><span class="mi">240</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Again, you can check that the IG feature attributions have the same shape as the input “Fireboat” image.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">ig_attributions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The paper suggests the number of steps to range between 20 to 300 depending upon the example (although in practice this can be higher in the 1,000s to accurately approximate the integral). You can find additional code to check for the appropriate number of steps in the “Next steps” resources at the end of this tutorial.</p>
</div>
<div class="section" id="Visualize-attributions">
<h3>Visualize attributions<a class="headerlink" href="#Visualize-attributions" title="Enlazar permanentemente con este título">¶</a></h3>
<p>You are ready to visualize attributions, and overlay them on the original image. The code below sums the absolute values of the integrated gradients across the color channels to produce an attribution mask. This plotting method captures the relative impact of pixels on the model’s predictions.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">plot_img_attributions</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span>
                          <span class="n">image</span><span class="p">,</span>
                          <span class="n">target_class_idx</span><span class="p">,</span>
                          <span class="n">m_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>

  <span class="n">attributions</span> <span class="o">=</span> <span class="n">integrated_gradients</span><span class="p">(</span><span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span>
                                      <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
                                      <span class="n">target_class_idx</span><span class="o">=</span><span class="n">target_class_idx</span><span class="p">,</span>
                                      <span class="n">m_steps</span><span class="o">=</span><span class="n">m_steps</span><span class="p">)</span>

  <span class="c1"># Sum of the attributions across color channels for visualization.</span>
  <span class="c1"># The attribution mask shape is a grayscale image with height and width</span>
  <span class="c1"># equal to the original image.</span>
  <span class="n">attribution_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">attributions</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

  <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Baseline image&#39;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original image&#39;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Attribution mask&#39;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">attribution_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Overlay&#39;</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">attribution_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">overlay_alpha</span><span class="p">)</span>
  <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

  <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">fig</span>
</pre></div>
</div>
</div>
<p>Looking at the attributions on the “Fireboat” image, you can see the model identifies the water cannons and spouts as contributing to its correct prediction.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plot_img_attributions</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">img_name_tensors</span><span class="p">[</span><span class="s1">&#39;Fireboat&#39;</span><span class="p">],</span>
                          <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span>
                          <span class="n">target_class_idx</span><span class="o">=</span><span class="mi">555</span><span class="p">,</span>
                          <span class="n">m_steps</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">inferno</span><span class="p">,</span>
                          <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>On the “Giant Panda” image, the attributions highlight the texture, nose, and the fur of the Panda’s face.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plot_img_attributions</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">img_name_tensors</span><span class="p">[</span><span class="s1">&#39;Giant Panda&#39;</span><span class="p">],</span>
                          <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span>
                          <span class="n">target_class_idx</span><span class="o">=</span><span class="mi">389</span><span class="p">,</span>
                          <span class="n">m_steps</span><span class="o">=</span><span class="mi">55</span><span class="p">,</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
                          <span class="n">overlay_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Uses-and-limitations">
<h2>Uses and limitations<a class="headerlink" href="#Uses-and-limitations" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Use cases * Employing techniques like Integrated Gradients before deploying your model can help you develop intuition for how and why it works. Do the features highlighted by this technique match your intuition? If not, that may be indicative of a bug in your model or dataset, or overfitting.</p>
<p>Limitations * Integrated Gradients provides feature importances on individual examples, however, it does not provide global feature importances across an entire dataset.</p>
<ul class="simple">
<li><p>Integrated Gradients provides individual feature importances, but it does not explain feature interactions and combinations.</p></li>
</ul>
</div>
<div class="section" id="Next-steps">
<h2>Next steps<a class="headerlink" href="#Next-steps" title="Enlazar permanentemente con este título">¶</a></h2>
<p>This tutorial presented a basic implementation of Integrated Gradients. As a next step, you can use this notebook to try this technique with different models and images yourself.</p>
<p>For interested readers, there is a lengthier version of this tutorial (which includes code for different baselines, to compute integral approximations, and to determine a sufficient number of steps) which you can find <a class="reference external" href="https://github.com/GoogleCloudPlatform/training-data-analyst/tree/master/blogs/integrated_gradients">here</a>.</p>
<p>To deepen your understanding, check out the paper <a class="reference external" href="https://arxiv.org/abs/1703.01365">Axiomatic Attribution for Deep Networks</a> and <a class="reference external" href="https://github.com/ankurtaly/Integrated-Gradients">Github repository</a>, which contains an implementation in a previous version of TensorFlow. You can also explore feature attribution, and the impact of different baselines, on <a class="reference external" href="https://distill.pub/2020/attribution-baselines/">distill.pub</a>.</p>
<p>Interested in incorporating IG into your production machine learning workflows for feature importances, model error analysis, and data skew monitoring? Check out Google Cloud’s <a class="reference external" href="https://cloud.google.com/explainable-ai">Explainable AI</a> product that supports IG attributions. The Google AI PAIR research group also open-sourced the <a class="reference external" href="https://pair-code.github.io/what-if-tool/index.html#about">What-if tool</a> which can be used for model debugging, including visualizing IG feature attributions.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Derechos de autor 2019, Juan D. Velasquez.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>