

<!DOCTYPE html>
<html class="writer-html5" lang="es" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Load CSV data &mdash; documentación de --- Cursos --- - </title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script src="../../../../_static/translations.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> --- Cursos ---
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Configuración</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">Instalación de Vagrant y Docker</a></li>
</ul>
<p class="caption"><span class="caption-text">Cursos de Pregrado</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../fundamentos-de-analitica/index.html">Fundamentos de Analítica</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html">Redes Neuronales Artificiales y Algoritmos Bioinspirados</a></li>
</ul>
<p class="caption"><span class="caption-text">Cursos de Posgrado</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica-de-grandes-datos/index.html">Analítica de Grandes Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica-predictiva/index.html">Analítica Predictiva</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ciencia-de-los-datos/index.html">Ciencia de los Datos Aplicada</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../productos-de-datos/index.html">Productos de Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica_avanzada/index.html">Analítica Avanzada</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">--- Cursos ---</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Load CSV data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../_sources/notebooks/tensorflow/tutorials/Load_and_process_data/1-02_csv.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Load-CSV-data">
<h1>Load CSV data<a class="headerlink" href="#Load-CSV-data" title="Enlazar permanentemente con este título">¶</a></h1>
<table class="tfo-notebook-buttons" align="left"><td><p><a href="#id1"><span class="problematic" id="id2">|</span></a>8df7eed9fa1040bcbe275467dea7ebf1|View on TensorFlow.org</p>
</td><td><p><a href="#id3"><span class="problematic" id="id4">|</span></a>e73d564d853d406cb9008100195a3e85|Run in Google Colab</p>
</td><td><p><a href="#id5"><span class="problematic" id="id6">|</span></a>c416d75e104b4e559d277725a884b56e|View source on GitHub</p>
</td><td><p><a href="#id7"><span class="problematic" id="id8">|</span></a>aa72a5578fb240f8b3c242458be75b20|Download notebook</p>
</td></table><p>This tutorial provides examples of how to use CSV data with TensorFlow.</p>
<p>There are two main parts to this:</p>
<ol class="arabic simple">
<li><p><strong>Loading the data off disk</strong></p></li>
<li><p><strong>Pre-processing it into a form suitable for training.</strong></p></li>
</ol>
<p>This tutorial focuses on the loading, and gives some quick examples of preprocessing. For a tutorial that focuses on the preprocessing aspect see the <a class="reference external" href="https://www.tensorflow.org/guide/keras/preprocessing_layers#quick_recipes">preprocessing layers guide</a> and <a class="reference external" href="https://www.tensorflow.org/tutorials/structured_data/preprocessing_layers">tutorial</a>.</p>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Make numpy values easier to read.</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers.experimental</span> <span class="kn">import</span> <span class="n">preprocessing</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="In-memory-data">
<h2>In memory data<a class="headerlink" href="#In-memory-data" title="Enlazar permanentemente con este título">¶</a></h2>
<p>For any small CSV dataset the simplest way to train a TensorFlow model on it is to load it into memory as a pandas Dataframe or a NumPy array.</p>
<p>A relatively simple example is the <a class="reference external" href="https://archive.ics.uci.edu/ml/datasets/abalone">abalone dataset</a>.</p>
<ul class="simple">
<li><p>The dataset is small.</p></li>
<li><p>All the input features are all limited-range floating point values.</p></li>
</ul>
<p>Here is how to download the data into a <cite>Pandas ``DataFrame`</cite> &lt;<a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html">https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html</a>&gt;`__:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">abalone_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;https://storage.googleapis.com/download.tensorflow.org/data/abalone_train.csv&quot;</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Length&quot;</span><span class="p">,</span> <span class="s2">&quot;Diameter&quot;</span><span class="p">,</span> <span class="s2">&quot;Height&quot;</span><span class="p">,</span> <span class="s2">&quot;Whole weight&quot;</span><span class="p">,</span> <span class="s2">&quot;Shucked weight&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Viscera weight&quot;</span><span class="p">,</span> <span class="s2">&quot;Shell weight&quot;</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">])</span>

<span class="n">abalone_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The dataset contains a set of measurements of <a class="reference external" href="https://en.wikipedia.org/wiki/Abalone">abalone</a>, a type of sea snail.</p>
<p><img alt="an abalone shell" src="https://tensorflow.org/images/abalone_shell.jpg" /></p>
<p><a class="reference external" href="https://www.flickr.com/photos/thenickster/16641048623/">“Abalone shell”</a> (by <a class="reference external" href="https://www.flickr.com/photos/thenickster/">Nicki Dugan Pogue</a>, CC BY-SA 2.0)</p>
<p>The nominal task for this dataset is to predict the age from the other measurements, so separate the features and labels for training:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">abalone_features</span> <span class="o">=</span> <span class="n">abalone_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">abalone_labels</span> <span class="o">=</span> <span class="n">abalone_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For this dataset you will treat all features identically. Pack the features into a single NumPy array.:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">abalone_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">abalone_features</span><span class="p">)</span>
<span class="n">abalone_features</span>
</pre></div>
</div>
</div>
<p>Next make a regression model predict the age. Since there is only a single input tensor, a <code class="docutils literal notranslate"><span class="pre">keras.Sequential</span></code> model is sufficient here.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">abalone_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">abalone_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
                      <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">())</span>
</pre></div>
</div>
</div>
<p>To train that model, pass the features and labels to <code class="docutils literal notranslate"><span class="pre">Model.fit</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">abalone_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">abalone_features</span><span class="p">,</span> <span class="n">abalone_labels</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You have just seen the most basic way to train a model using CSV data. Next, you will learn how to apply preprocessing to normalize numeric columns.</p>
</div>
<div class="section" id="Basic-preprocessing">
<h2>Basic preprocessing<a class="headerlink" href="#Basic-preprocessing" title="Enlazar permanentemente con este título">¶</a></h2>
<p>It’s good practice to normalize the inputs to your model. The <code class="docutils literal notranslate"><span class="pre">experimental.preprocessing</span></code> layers provide a convenient way to build this normalization into your model.</p>
<p>The layer will precompute the mean and variance of each column, and use these to normalize the data.</p>
<p>First you create the layer:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">normalize</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">Normalization</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Then you use the <code class="docutils literal notranslate"><span class="pre">Normalization.adapt()</span></code> method to adapt the normalization layer to your data.</p>
<p>Note: Only use your training data to <code class="docutils literal notranslate"><span class="pre">.adapt()</span></code> preprocessing layers. Do not use your validation or test data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">normalize</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">abalone_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Then use the normalization layer in your model:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">norm_abalone_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
  <span class="n">normalize</span><span class="p">,</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
  <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">norm_abalone_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
                           <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">())</span>

<span class="n">norm_abalone_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">abalone_features</span><span class="p">,</span> <span class="n">abalone_labels</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Mixed-data-types">
<h2>Mixed data types<a class="headerlink" href="#Mixed-data-types" title="Enlazar permanentemente con este título">¶</a></h2>
<p>The “Titanic” dataset contains information about the passengers on the Titanic. The nominal task on this dataset is to predict who survived.</p>
<p><img alt="The Titanic" src="notebooks/tensorflow/tutorials/Load_and_process_data/images/csv/Titanic.jpg" /></p>
<p>Image <a class="reference external" href="https://commons.wikimedia.org/wiki/File:RMS_Titanic_3.jpg">from Wikimedia</a></p>
<p>The raw data can easily be loaded as a Pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, but is not immediately usable as input to a TensorFlow model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://storage.googleapis.com/tf-datasets/titanic/train.csv&quot;</span><span class="p">)</span>
<span class="n">titanic</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_features</span> <span class="o">=</span> <span class="n">titanic</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">titanic_labels</span> <span class="o">=</span> <span class="n">titanic_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;survived&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Because of the different data types and ranges you can’t simply stack the features into NumPy array and pass it to a <code class="docutils literal notranslate"><span class="pre">keras.Sequential</span></code> model. Each column needs to be handled individually.</p>
<p>As one option, you could preprocess your data offline (using any tool you like) to convert categorical columns to numeric columns, then pass the processed output to your TensorFlow model. The disadvantage to that approach is that if you save and export your model the preprocessing is not saved with it. The <code class="docutils literal notranslate"><span class="pre">experimental.preprocessing</span></code> layers avoid this problem because they’re part of the model.</p>
<p>In this example, you’ll build a model that implements the preprocessing logic using <a class="reference external" href="https://www.tensorflow.org/guide/keras/functional.ipynb">Keras functional API</a>. You could also do it by <a class="reference external" href="https://www.tensorflow.org/guide/keras/custom_layers_and_models">subclassing</a>.</p>
<p>The functional API operates on “symbolic” tensors. Normal “eager” tensors have a value. In contrast these “symbolic” tensors do not. Instead they keep track of which operations are run on them, and build representation of the calculation, that you can run later. Here’s a quick example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Create a symbolic input</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Do a calculation using is</span>
<span class="n">result</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">input</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># the result doesn&#39;t have a value</span>
<span class="n">result</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">calc</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">calc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">calc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<p>To build the preprocessing model, start by building a set of symbolic <code class="docutils literal notranslate"><span class="pre">keras.Input</span></code> objects, matching the names and data-types of the CSV columns.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">titanic_features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">dtype</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">object</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>

  <span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="n">inputs</span>
</pre></div>
</div>
</div>
<p>The first step in your preprocessing logic is to concatenate the numeric inputs together, and run them through a normalization layer:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">numeric_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="nb">input</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="nb">input</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">()(</span><span class="nb">list</span><span class="p">(</span><span class="n">numeric_inputs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">Normalization</span><span class="p">()</span>
<span class="n">norm</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">titanic</span><span class="p">[</span><span class="n">numeric_inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]))</span>
<span class="n">all_numeric_inputs</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">all_numeric_inputs</span>
</pre></div>
</div>
</div>
<p>Collect all the symbolic preprocessing results, to concatenate them later.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">preprocessed_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_numeric_inputs</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>For the string inputs use the <code class="docutils literal notranslate"><span class="pre">preprocessing.StringLookup</span></code> function to map from strings to integer indices in a vocabulary. Next, use <code class="docutils literal notranslate"><span class="pre">preprocessing.CategoryEncoding</span></code> to convert the indexes into <code class="docutils literal notranslate"><span class="pre">float32</span></code> data appropriate for the model.</p>
<p>The default settings for the <code class="docutils literal notranslate"><span class="pre">preprocessing.CategoryEncoding</span></code> layer create a one-hot vector for each input. A <code class="docutils literal notranslate"><span class="pre">layers.Embedding</span></code> would also work. See the <a class="reference external" href="https://www.tensorflow.org/guide/keras/preprocessing_layers#quick_recipes">preprocessing layers guide</a> and <a class="reference external" href="../structured_data/preprocessing_layers.ipynb">tutorial</a> for more on this topic.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
    <span class="k">continue</span>

  <span class="n">lookup</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">StringLookup</span><span class="p">(</span><span class="n">vocabulary</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">titanic_features</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
  <span class="n">one_hot</span> <span class="o">=</span> <span class="n">preprocessing</span><span class="o">.</span><span class="n">CategoryEncoding</span><span class="p">(</span><span class="n">max_tokens</span><span class="o">=</span><span class="n">lookup</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">())</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">one_hot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">preprocessed_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>With the collection of <code class="docutils literal notranslate"><span class="pre">inputs</span></code> and <code class="docutils literal notranslate"><span class="pre">processed_inputs</span></code>, you can concatenate all the preprocessed inputs together, and build a model that handles the preprocessing:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">preprocessed_inputs_cat</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">()(</span><span class="n">preprocessed_inputs</span><span class="p">)</span>

<span class="n">titanic_preprocessing</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">preprocessed_inputs_cat</span><span class="p">)</span>

<span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">plot_model</span><span class="p">(</span><span class="n">model</span> <span class="o">=</span> <span class="n">titanic_preprocessing</span> <span class="p">,</span> <span class="n">rankdir</span><span class="o">=</span><span class="s2">&quot;LR&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">72</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">model</span></code> just contains the input preprocessing. You can run it to see what it does to your data. Keras models don’t automatically convert Pandas <code class="docutils literal notranslate"><span class="pre">DataFrames</span></code> because it’s not clear if it should be converted to one tensor or to a dictionary of tensors. So convert it to a dictionary of tensors:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_features_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">titanic_features</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<p>Slice out the first training example and pass it to this preprocessing model, you see the numeric features and string one-hots all concatenated together:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">features_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">values</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">titanic_features_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">titanic_preprocessing</span><span class="p">(</span><span class="n">features_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now build the model on top of this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">titanic_model</span><span class="p">(</span><span class="n">preprocessing_head</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
  <span class="n">body</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">])</span>

  <span class="n">preprocessed_inputs</span> <span class="o">=</span> <span class="n">preprocessing_head</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">body</span><span class="p">(</span><span class="n">preprocessed_inputs</span><span class="p">)</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

  <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">BinaryCrossentropy</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">model</span>

<span class="n">titanic_model</span> <span class="o">=</span> <span class="n">titanic_model</span><span class="p">(</span><span class="n">titanic_preprocessing</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>When you train the model, pass the dictionary of features as <code class="docutils literal notranslate"><span class="pre">x</span></code>, and the label as <code class="docutils literal notranslate"><span class="pre">y</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">titanic_features_dict</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">titanic_labels</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Since the preprocessing is part of the model, you can save the model and reload it somewhere else and get identical results:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">reloaded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">features_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">values</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">titanic_features_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">before</span> <span class="o">=</span> <span class="n">titanic_model</span><span class="p">(</span><span class="n">features_dict</span><span class="p">)</span>
<span class="n">after</span> <span class="o">=</span> <span class="n">reloaded</span><span class="p">(</span><span class="n">features_dict</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">before</span><span class="o">-</span><span class="n">after</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-3</span>
<span class="nb">print</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Using-tf.data">
<h2>Using tf.data<a class="headerlink" href="#Using-tf.data" title="Enlazar permanentemente con este título">¶</a></h2>
<p>In the previous section you relied on the model’s built-in data shuffling and batching while training the model.</p>
<p>If you need more control over the input data pipeline or need to use data that doesn’t easily fit into memory: use <code class="docutils literal notranslate"><span class="pre">tf.data</span></code>.</p>
<p>For more examples see the <a class="reference internal" href="../../guide/data.html"><span class="doc">tf.data guide</span></a>.</p>
<div class="section" id="On-in-memory-data">
<h3>On in memory data<a class="headerlink" href="#On-in-memory-data" title="Enlazar permanentemente con este título">¶</a></h3>
<p>As a first example of applying <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> to CSV data consider the following code to manually slice up the dictionary of features from the previous section. For each index, it takes that index for each feature:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span>

<span class="k">def</span> <span class="nf">slices</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
    <span class="c1"># For each feature take index `i`</span>
    <span class="n">example</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">yield</span> <span class="n">example</span>
</pre></div>
</div>
</div>
<p>Run this and print the first example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">(</span><span class="n">titanic_features_dict</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">19s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">break</span>
</pre></div>
</div>
</div>
<p>The most basic <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> in memory data loader is the <code class="docutils literal notranslate"><span class="pre">Dataset.from_tensor_slices</span></code> constructor. This returns a <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> that implements a generalized version of the above <code class="docutils literal notranslate"><span class="pre">slices</span></code> function, in TensorFlow.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">features_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">titanic_features_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>You can iterate over a <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> like any other python iterable:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">features_ds</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">example</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">19s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="k">break</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">from_tensor_slices</span></code> function can handle any structure of nested dictionaries or tuples. The following code makes a dataset of <code class="docutils literal notranslate"><span class="pre">(features_dict,</span> <span class="pre">labels)</span></code> pairs:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">titanic_features_dict</span><span class="p">,</span> <span class="n">titanic_labels</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>To train a model using this <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>, you’ll need to at least <code class="docutils literal notranslate"><span class="pre">shuffle</span></code> and <code class="docutils literal notranslate"><span class="pre">batch</span></code> the data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_batches</span> <span class="o">=</span> <span class="n">titanic_ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">titanic_labels</span><span class="p">))</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Instead of passing <code class="docutils literal notranslate"><span class="pre">features</span></code> and <code class="docutils literal notranslate"><span class="pre">labels</span></code> to <code class="docutils literal notranslate"><span class="pre">Model.fit</span></code>, you pass the dataset:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">titanic_batches</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="From-a-single-file">
<h3>From a single file<a class="headerlink" href="#From-a-single-file" title="Enlazar permanentemente con este título">¶</a></h3>
<p>So far this tutorial has worked with in-memory data. <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> is a highly scalable toolkit for building data pipelines, and provides a few functions for dealing loading CSV files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_file_path</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="s2">&quot;train.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;https://storage.googleapis.com/tf-datasets/titanic/train.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now read the CSV data from the file and create a <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code>.</p>
<p>(For the full documentation, see <code class="docutils literal notranslate"><span class="pre">tf.data.experimental.make_csv_dataset</span></code>)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_csv_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_csv_dataset</span><span class="p">(</span>
    <span class="n">titanic_file_path</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># Artificially small to make examples easier to show.</span>
    <span class="n">label_name</span><span class="o">=</span><span class="s1">&#39;survived&#39;</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,)</span>
</pre></div>
</div>
</div>
<p>This function includes many convenient features so the data is easy to work with. This includes:</p>
<ul class="simple">
<li><p>Using the column headers as dictionary keys.</p></li>
<li><p>Automatically determining the type of each column.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">titanic_csv_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;label&#39;</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note: if you run the above cell twice it will produce different results. The default settings for <code class="docutils literal notranslate"><span class="pre">make_csv_dataset</span></code> include <code class="docutils literal notranslate"><span class="pre">shuffle_buffer_size=1000</span></code>, which is more than sufficient for this small dataset, but may not be for a real-world dataset.</p>
<p>It can also decompress the data on the fly. Here’s a gzipped CSV file containing the <a class="reference external" href="https://archive.ics.uci.edu/ml/datasets/Metro+Interstate+Traffic+Volume">metro interstate traffic dataset</a></p>
<p><img alt="A traffic jam." src="notebooks/tensorflow/tutorials/Load_and_process_data/images/csv/traffic.jpg" /></p>
<p>Image <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Trafficjam.jpg">from Wikimedia</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">traffic_volume_csv_gz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span>
    <span class="s1">&#39;Metro_Interstate_Traffic_Volume.csv.gz&#39;</span><span class="p">,</span>
    <span class="s2">&quot;https://archive.ics.uci.edu/ml/machine-learning-databases/00492/Metro_Interstate_Traffic_Volume.csv.gz&quot;</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">cache_subdir</span><span class="o">=</span><span class="s1">&#39;traffic&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Set the <code class="docutils literal notranslate"><span class="pre">compression_type</span></code> argument to read directly from the compressed file:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">traffic_volume_csv_gz_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_csv_dataset</span><span class="p">(</span>
    <span class="n">traffic_volume_csv_gz</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">label_name</span><span class="o">=</span><span class="s1">&#39;traffic_volume&#39;</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">compression_type</span><span class="o">=</span><span class="s2">&quot;GZIP&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">traffic_volume_csv_gz_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;label&#39;</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">label</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note: If you need to parse those date-time strings in the <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> pipeline you can use <code class="docutils literal notranslate"><span class="pre">tfa.text.parse_time</span></code>.</p>
</div>
<div class="section" id="Caching">
<h3>Caching<a class="headerlink" href="#Caching" title="Enlazar permanentemente con este título">¶</a></h3>
<p>There is some overhead to parsing the csv data. For small models this can be the bottleneck in training.</p>
<p>Depending on your use case it may be a good idea to use <code class="docutils literal notranslate"><span class="pre">Dataset.cache</span></code> or <code class="docutils literal notranslate"><span class="pre">data.experimental.snapshot</span></code> so that the csv data is only parsed on the first epoch.</p>
<p>The main difference between the <code class="docutils literal notranslate"><span class="pre">cache</span></code> and <code class="docutils literal notranslate"><span class="pre">snapshot</span></code> methods is that <code class="docutils literal notranslate"><span class="pre">cache</span></code> files can only be used by the TensorFlow process that created them, but <code class="docutils literal notranslate"><span class="pre">snapshot</span></code> files can be read by other processes.</p>
<p>For example, iterating over the <code class="docutils literal notranslate"><span class="pre">traffic_volume_csv_gz_ds</span></code> 20 times, takes ~15 seconds without caching, or ~2s with caching.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traffic_volume_csv_gz_ds</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">20</span><span class="p">)):</span>
  <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">40</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Note: <code class="docutils literal notranslate"><span class="pre">Dataset.cache</span></code> stores the data form the first epoch and replays it in order. So using <code class="docutils literal notranslate"><span class="pre">.cache</span></code> disables any shuffles earlier in the pipeline. Below the <code class="docutils literal notranslate"><span class="pre">.shuffle</span></code> is added back in after <code class="docutils literal notranslate"><span class="pre">.cache</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">caching</span> <span class="o">=</span> <span class="n">traffic_volume_csv_gz_ds</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">caching</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">20</span><span class="p">)):</span>
  <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">40</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Note: <code class="docutils literal notranslate"><span class="pre">snapshot</span></code> files are meant for <em>temporary</em> storage of a dataset while in use. This is <em>not</em> a format for long term storage. The file format is considered an internal detail, and not guaranteed between TensorFlow versions.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="n">snapshot</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">snapshot</span><span class="p">(</span><span class="s1">&#39;titanic.tfsnap&#39;</span><span class="p">)</span>
<span class="n">snapshotting</span> <span class="o">=</span> <span class="n">traffic_volume_csv_gz_ds</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">snapshotting</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">20</span><span class="p">)):</span>
  <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">40</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>If your data loading is slowed by loading csv files, and <code class="docutils literal notranslate"><span class="pre">cache</span></code> and <code class="docutils literal notranslate"><span class="pre">snapshot</span></code> are insufficient for your use case, consider re-encoding your data into a more streamlined format.</p>
</div>
<div class="section" id="Multiple-files">
<h3>Multiple files<a class="headerlink" href="#Multiple-files" title="Enlazar permanentemente con este título">¶</a></h3>
<p>All the examples so far in this section could easily be done without <code class="docutils literal notranslate"><span class="pre">tf.data</span></code>. One place where <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> can really simplify things is when dealing with collections of files.</p>
<p>For example, the <a class="reference external" href="https://archive.ics.uci.edu/ml/datasets/Character+Font+Images">character font images</a> dataset is distributed as a collection of csv files, one per font.</p>
<p><img alt="Fonts" src="notebooks/tensorflow/tutorials/Load_and_process_data/images/csv/fonts.jpg" /></p>
<p>Image by Willi Heidelbach from Pixabay</p>
<p>Download the dataset, and have a look at the files inside:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fonts_zip</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span>
    <span class="s1">&#39;fonts.zip&#39;</span><span class="p">,</span>  <span class="s2">&quot;https://archive.ics.uci.edu/ml/machine-learning-databases/00417/fonts.zip&quot;</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">cache_subdir</span><span class="o">=</span><span class="s1">&#39;fonts&#39;</span><span class="p">,</span>
    <span class="n">extract</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pathlib</span>
<span class="n">font_csvs</span> <span class="o">=</span>  <span class="nb">sorted</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;fonts&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.csv&quot;</span><span class="p">))</span>

<span class="n">font_csvs</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">len</span><span class="p">(</span><span class="n">font_csvs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>When dealing with a bunch of files you can pass a glob-style <code class="docutils literal notranslate"><span class="pre">file_pattern</span></code> to the <code class="docutils literal notranslate"><span class="pre">experimental.make_csv_dataset</span></code> function. The order of the files is shuffled each iteration.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">num_parallel_reads</span></code> argument to set how many files are read in parallel and interleaved together.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fonts_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_csv_dataset</span><span class="p">(</span>
    <span class="n">file_pattern</span> <span class="o">=</span> <span class="s2">&quot;fonts/*.csv&quot;</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">num_parallel_reads</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">shuffle_buffer_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>These csv files have the images flattened out into a single row. The column names are formatted <code class="docutils literal notranslate"><span class="pre">r{row}c{column}</span></code>. Here’s the first batch:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">fonts_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">15</span><span class="p">:</span>
      <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="si">}</span><span class="s2"> features]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Optional:-Packing-fields">
<h4>Optional: Packing fields<a class="headerlink" href="#Optional:-Packing-fields" title="Enlazar permanentemente con este título">¶</a></h4>
<p>You probably don’t want to work with each pixel in separate columns like this. Before trying to use this dataset be sure to pack the pixels into an image-tensor.</p>
<p>Here is code that parses the column names to build images for each example:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">make_images</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
  <span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">400</span>
  <span class="n">new_feats</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;r(\d+)c(\d+)&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
      <span class="n">image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mi">20</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">new_feats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
  <span class="n">new_feats</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>

  <span class="k">return</span> <span class="n">new_feats</span>
</pre></div>
</div>
</div>
<p>Apply that function to each batch in the dataset:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fonts_image_ds</span> <span class="o">=</span> <span class="n">fonts_ds</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">make_images</span><span class="p">)</span>

<span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">fonts_image_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="k">break</span>
</pre></div>
</div>
</div>
<p>Plot the resulting images:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;m_label&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="Lower-level-functions">
<h2>Lower level functions<a class="headerlink" href="#Lower-level-functions" title="Enlazar permanentemente con este título">¶</a></h2>
<p>So far this tutorial has focused on the highest level utilities for reading csv data. There are other two APIs that may be helpful for advanced users if your use-case doesn’t fit the basic patterns.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tf.io.decode_csv</span></code> - a function for parsing lines of text into a list of CSV column tensors.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tf.data.experimental.CsvDataset</span></code> - a lower level csv dataset constructor.</p></li>
</ul>
<p>This section recreates functionality provided by <code class="docutils literal notranslate"><span class="pre">make_csv_dataset</span></code>, to demonstrate how this lower level functionality can be used.</p>
<div class="section" id="tf.io.decode_csv">
<h3><code class="docutils literal notranslate"><span class="pre">tf.io.decode_csv</span></code><a class="headerlink" href="#tf.io.decode_csv" title="Enlazar permanentemente con este título">¶</a></h3>
<p>This function decodes a string, or list of strings into a list of columns.</p>
<p>Unlike <code class="docutils literal notranslate"><span class="pre">make_csv_dataset</span></code> this function does not try to guess column data-types. You specify the column types by providing a list of <code class="docutils literal notranslate"><span class="pre">record_defaults</span></code> containing a value of the correct type, for each column.</p>
<p>To read the Titanic data <strong>as strings</strong> using <code class="docutils literal notranslate"><span class="pre">decode_csv</span></code> you would say:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">text</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">titanic_file_path</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">all_strings</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">()]</span><span class="o">*</span><span class="mi">10</span>
<span class="n">all_strings</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">record_defaults</span><span class="o">=</span><span class="n">all_strings</span><span class="p">)</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;type: </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, shape: </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>To parse them with their actual types, create a list of <code class="docutils literal notranslate"><span class="pre">record_defaults</span></code> of the corresponding types:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">titanic_types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(),</span> <span class="nb">float</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(),</span> <span class="nb">float</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(),</span> <span class="nb">str</span><span class="p">()]</span>
<span class="n">titanic_types</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">record_defaults</span><span class="o">=</span><span class="n">titanic_types</span><span class="p">)</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;type: </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, shape: </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note: it is more efficient to call <code class="docutils literal notranslate"><span class="pre">decode_csv</span></code> on large batches of lines than on individual lines of csv text.</p>
</div>
<div class="section" id="tf.data.experimental.CsvDataset">
<h3><code class="docutils literal notranslate"><span class="pre">tf.data.experimental.CsvDataset</span></code><a class="headerlink" href="#tf.data.experimental.CsvDataset" title="Enlazar permanentemente con este título">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">tf.data.experimental.CsvDataset</span></code> class provides a minimal CSV <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> interface without the convenience features of the <code class="docutils literal notranslate"><span class="pre">make_csv_dataset</span></code> function: column header parsing, column type-inference, automatic shuffling, file interleaving.</p>
<p>This constructor follows uses <code class="docutils literal notranslate"><span class="pre">record_defaults</span></code> the same way as <code class="docutils literal notranslate"><span class="pre">io.parse_csv</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simple_titanic</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">CsvDataset</span><span class="p">(</span><span class="n">titanic_file_path</span><span class="p">,</span> <span class="n">record_defaults</span><span class="o">=</span><span class="n">titanic_types</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">simple_titanic</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">example</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>The above code is basically equivalent to:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">decode_titanic_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">titanic_types</span><span class="p">)</span>

<span class="n">manual_titanic</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c1"># Load the lines of text</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TextLineDataset</span><span class="p">(</span><span class="n">titanic_file_path</span><span class="p">)</span>
    <span class="c1"># Skip the header row.</span>
    <span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Decode the line.</span>
    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">decode_titanic_line</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">manual_titanic</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">example</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h4>Multiple files<a class="headerlink" href="#id9" title="Enlazar permanentemente con este título">¶</a></h4>
<p>To parse the fonts dataset using <code class="docutils literal notranslate"><span class="pre">experimental.CsvDataset</span></code>, you first need to determine the column types for the <code class="docutils literal notranslate"><span class="pre">record_defaults</span></code>. Start by inspecting the first row of one file:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">font_line</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">font_csvs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">font_line</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Only the first two fields are strings, the rest are ints or floats, and you can get the total number of features by counting the commas:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">num_font_features</span> <span class="o">=</span> <span class="n">font_line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
<span class="n">font_column_types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(),</span> <span class="nb">str</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">float</span><span class="p">()]</span><span class="o">*</span><span class="p">(</span><span class="n">num_font_features</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">CsvDatasaet</span></code> constructor can take a list of input files, but reads them sequentially. The first file in the list of CSVs is <code class="docutils literal notranslate"><span class="pre">AGENCY.csv</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">font_csvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>So when you pass pass the list of files to <code class="docutils literal notranslate"><span class="pre">CsvDataaset</span></code> the records from <code class="docutils literal notranslate"><span class="pre">AGENCY.csv</span></code> are read first:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">simple_font_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">CsvDataset</span><span class="p">(</span>
    <span class="n">font_csvs</span><span class="p">,</span>
    <span class="n">record_defaults</span><span class="o">=</span><span class="n">font_column_types</span><span class="p">,</span>
    <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">simple_font_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<p>To interleave multiple files, use <code class="docutils literal notranslate"><span class="pre">Dataset.interleave</span></code>.</p>
<p>Here’s an initial dataset that contains the csv file names:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">font_files</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="s2">&quot;fonts/*.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This shuffles the file names each epoch:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch 1:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">font_files</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    &quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch 2:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">font_files</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    &quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    ...&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">interleave</span></code> method takes a <code class="docutils literal notranslate"><span class="pre">map_func</span></code> that creates a child-<code class="docutils literal notranslate"><span class="pre">Dataset</span></code> for each element of the parent-<code class="docutils literal notranslate"><span class="pre">Dataset</span></code>.</p>
<p>Here, you want to create a <code class="docutils literal notranslate"><span class="pre">CsvDataset</span></code> from each element of the dataset of files:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">make_font_csv_ds</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">CsvDataset</span><span class="p">(</span>
    <span class="n">path</span><span class="p">,</span>
    <span class="n">record_defaults</span><span class="o">=</span><span class="n">font_column_types</span><span class="p">,</span>
    <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> returned by interleave returns elements by cycling over a number of the child-<code class="docutils literal notranslate"><span class="pre">Dataset</span></code>s. Note, below, how the dataset cycles over <code class="docutils literal notranslate"><span class="pre">cycle_length)=3</span></code> three font files:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">font_rows</span> <span class="o">=</span> <span class="n">font_files</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span><span class="n">make_font_csv_ds</span><span class="p">,</span>
                                  <span class="n">cycle_length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fonts_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;font_name&#39;</span><span class="p">:[],</span> <span class="s1">&#39;character&#39;</span><span class="p">:[]}</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">font_rows</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="n">fonts_dict</span><span class="p">[</span><span class="s1">&#39;font_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
  <span class="n">fonts_dict</span><span class="p">[</span><span class="s1">&#39;character&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>

<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fonts_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Performance">
<h4>Performance<a class="headerlink" href="#Performance" title="Enlazar permanentemente con este título">¶</a></h4>
<p>Earlier, it was noted that <code class="docutils literal notranslate"><span class="pre">io.decode_csv</span></code> is more efficient when run on a batch of strings.</p>
<p>It is possible to take advantage of this fact, when using large batch sizes, to improve CSV loading performance (but try <a class="reference external" href="#caching">caching</a> first).</p>
<p>With the built-in loader 20, 2048-example batches take about 17s.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">BATCH_SIZE</span><span class="o">=</span><span class="mi">2048</span>
<span class="n">fonts_ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">make_csv_dataset</span><span class="p">(</span>
    <span class="n">file_pattern</span> <span class="o">=</span> <span class="s2">&quot;fonts/*.csv&quot;</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">num_parallel_reads</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fonts_ds</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">20</span><span class="p">)):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Passing <strong>batches of text lines</strong> to<code class="docutils literal notranslate"><span class="pre">decode_csv</span></code> runs faster, in about 5s:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fonts_files</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">list_files</span><span class="p">(</span><span class="s2">&quot;fonts/*.csv&quot;</span><span class="p">)</span>
<span class="n">fonts_lines</span> <span class="o">=</span> <span class="n">fonts_files</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">fname</span><span class="p">:</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TextLineDataset</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">cycle_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>

<span class="n">fonts_fast</span> <span class="o">=</span> <span class="n">fonts_lines</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_csv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">record_defaults</span><span class="o">=</span><span class="n">font_column_types</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%time</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fonts_fast</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">20</span><span class="p">)):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>For another example of increasing csv performance by using large batches see the <a class="reference external" href="../keras/overfit_and_underfit.ipynb">overfit and underfit tutorial</a>.</p>
<p>This sort of approach may work, but consider other options like <code class="docutils literal notranslate"><span class="pre">cache</span></code> and <code class="docutils literal notranslate"><span class="pre">snapshot</span></code>, or re-enncoding your data into a more streamlined format.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Derechos de autor 2019, Juan D. Velasquez.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>