

<!DOCTYPE html>
<html class="writer-html5" lang="es" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>TFRecord and tf.train.Example &mdash; documentación de --- Cursos --- - </title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../../../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
        <script type="text/javascript" src="../../../../_static/translations.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Índice" href="../../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../../search.html" />
    <link rel="next" title="Tokenizing with TF Text" href="1-10_tokenizers.html" />
    <link rel="prev" title="Subword tokenizers" href="1-08_subwords_tokenizer.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> --- Cursos ---
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Configuración</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">Instalación de Vagrant y Docker</a></li>
</ul>
<p class="caption"><span class="caption-text">Cursos de Pregrado</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../fundamentos-de-analitica/index.html">Fundamentos de Analítica</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html">Redes Neuronales Artificiales y Algoritmos Bioinspirados</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-01">Sesión 01</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-02">Sesión 02</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-03">Sesión 03</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-04">Sesión 04</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-05">Sesión 05</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-06">Sesión 06</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-07">Sesión 07</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-08">Sesión 08</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-09">Sesión 09</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-10">Sesión 10</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-11">Sesión 11</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-12">Sesión 12</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-13">Sesión 13</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-14">Sesión 14</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-15">Sesión 15</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html#sesion-16">Sesión 16</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Cursos de Posgrado</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica-de-grandes-datos/index.html">Analítica de Grandes Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analitica-predictiva/index.html">Analítica Predictiva</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ciencia-de-los-datos/index.html">Ciencia de los Datos Aplicada</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../productos-de-datos/index.html">Productos de Datos</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">--- Cursos ---</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../redes_neuronales_y_algoritmos_bioinspirados/index.html">Redes Neuronales Artificiales y Algoritmos Bioinspirados</a> &raquo;</li>
        
      <li>TFRecord and tf.train.Example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../_sources/notebooks/tensorflow/tutorials/Load_and_process_data/1-09_tfrecord.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="TFRecord-and-tf.train.Example">
<h1>TFRecord and tf.train.Example<a class="headerlink" href="#TFRecord-and-tf.train.Example" title="Enlazar permanentemente con este título">¶</a></h1>
<table class="tfo-notebook-buttons" align="left"><td><p><a href="#id1"><span class="problematic" id="id2">|</span></a>e9fd529dec5b489cafbe1a542c8bd64f|View on TensorFlow.org</p>
</td><td><p><a href="#id3"><span class="problematic" id="id4">|</span></a>5c5ff65458d942f690bd25d11dcbb889|Run in Google Colab</p>
</td><td><p><a href="#id5"><span class="problematic" id="id6">|</span></a>19bf6617a9764526b451c1f824d03e2f|View source on GitHub</p>
</td><td><p><a href="#id7"><span class="problematic" id="id8">|</span></a>7fc6c1991c0d433880b3c6d66753cb67|Download notebook</p>
</td></table><p>The TFRecord format is a simple format for storing a sequence of binary records.</p>
<p><a class="reference external" href="https://developers.google.com/protocol-buffers/">Protocol buffers</a> are a cross-platform, cross-language library for efficient serialization of structured data.</p>
<p>Protocol messages are defined by <code class="docutils literal notranslate"><span class="pre">.proto</span></code> files, these are often the easiest way to understand a message type.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> message (or protobuf) is a flexible message type that represents a <code class="docutils literal notranslate"><span class="pre">{&quot;string&quot;:</span> <span class="pre">value}</span></code> mapping. It is designed for use with TensorFlow and is used throughout the higher-level APIs such as <a class="reference external" href="https://www.tensorflow.org/tfx/">TFX</a>.</p>
<p>This notebook will demonstrate how to create, parse, and use the <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> message, and then serialize, write, and read <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> messages to and from <code class="docutils literal notranslate"><span class="pre">.tfrecord</span></code> files.</p>
<p>Note: While useful, these structures are optional. There is no need to convert existing code to use TFRecords, unless you are using <code class="docutils literal notranslate"><span class="pre">`tf.data</span></code> &lt;<a class="reference external" href="https://www.tensorflow.org/guide/data">https://www.tensorflow.org/guide/data</a>&gt;`__ and reading data is still the bottleneck to training. See <a class="reference external" href="https://www.tensorflow.org/guide/performance/datasets">Data Input Pipeline Performance</a> for dataset performance tips.</p>
<p>Note: In general, you should shard your data across multiple files so that you can parallelize I/O (within a single host or across multiple hosts). The rule of thumb is to have at least 10 times as many files as there will be hosts reading data. At the same time, each file should be large enough (at least 10+MB and ideally 100MB+) so that you benefit from I/O prefetching. For example, say you have <code class="docutils literal notranslate"><span class="pre">X</span></code> GBs of data and you plan to train on up to <code class="docutils literal notranslate"><span class="pre">N</span></code> hosts. Ideally, you should shard the data to
~<code class="docutils literal notranslate"><span class="pre">10*N</span></code> files, as long as ~<code class="docutils literal notranslate"><span class="pre">X/(10*N)</span></code> is 10+ MBs (and ideally 100+ MBs). If it is less than that, you might need to create fewer shards to trade off parallelism benefits and I/O prefetching benefits.</p>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">IPython.display</span> <span class="k">as</span> <span class="nn">display</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="tf.train.Example">
<h2><code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code><a class="headerlink" href="#tf.train.Example" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="section" id="Data-types-for-tf.train.Example">
<h3>Data types for <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code><a class="headerlink" href="#Data-types-for-tf.train.Example" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Fundamentally, a <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> is a <code class="docutils literal notranslate"><span class="pre">{&quot;string&quot;:</span> <span class="pre">tf.train.Feature}</span></code> mapping.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">tf.train.Feature</span></code> message type can accept one of the following three types (See the <code class="docutils literal notranslate"><span class="pre">`.proto</span></code> file &lt;<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/example/feature.proto">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/example/feature.proto</a>&gt;`__ for reference). Most other generic types can be coerced into one of these:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tf.train.BytesList</span></code> (the following types can be coerced)</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">string</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">byte</span></code></p></li>
</ul>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tf.train.FloatList</span></code> (the following types can be coerced)</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">float</span></code> (<code class="docutils literal notranslate"><span class="pre">float32</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">double</span></code> (<code class="docutils literal notranslate"><span class="pre">float64</span></code>)</p></li>
</ul>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tf.train.Int64List</span></code> (the following types can be coerced)</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bool</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">enum</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">int32</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uint32</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">int64</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uint64</span></code></p></li>
</ul>
<p>In order to convert a standard TensorFlow type to a <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code>-compatible <code class="docutils literal notranslate"><span class="pre">tf.train.Feature</span></code>, you can use the shortcut functions below. Note that each function takes a scalar input value and returns a <code class="docutils literal notranslate"><span class="pre">tf.train.Feature</span></code> containing one of the three <code class="docutils literal notranslate"><span class="pre">list</span></code> types above:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># The following functions can be used to convert a value to a type compatible</span>
<span class="c1"># with tf.train.Example.</span>

<span class="k">def</span> <span class="nf">_bytes_feature</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns a bytes_list from a string / byte.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">))):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="c1"># BytesList won&#39;t unpack a string from an EagerTensor.</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">bytes_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">BytesList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">value</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">_float_feature</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns a float_list from a float / double.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">float_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">FloatList</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">value</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">_int64_feature</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns an int64_list from a bool / enum / int / uint.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">int64_list</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Int64List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">value</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<p>Note: To stay simple, this example only uses scalar inputs. The simplest way to handle non-scalar features is to use <code class="docutils literal notranslate"><span class="pre">tf.io.serialize_tensor</span></code> to convert tensors to binary-strings. Strings are scalars in tensorflow. Use <code class="docutils literal notranslate"><span class="pre">tf.io.parse_tensor</span></code> to convert the binary-string back to a tensor.</p>
<p>Below are some examples of how these functions work. Note the varying input types and the standardized output types. If the input type for a function does not match one of the coercible types stated above, the function will raise an exception (e.g. <code class="docutils literal notranslate"><span class="pre">_int64_feature(1.0)</span></code> will error out, since <code class="docutils literal notranslate"><span class="pre">1.0</span></code> is a float, so should be used with the <code class="docutils literal notranslate"><span class="pre">_float_feature</span></code> function instead):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">_bytes_feature</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;test_string&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">_bytes_feature</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;test_bytes&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">_float_feature</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">_int64_feature</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">_int64_feature</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>All proto messages can be serialized to a binary-string using the <code class="docutils literal notranslate"><span class="pre">.SerializeToString</span></code> method:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">feature</span> <span class="o">=</span> <span class="n">_float_feature</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="n">feature</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Creating-a-tf.train.Example-message">
<h3>Creating a <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> message<a class="headerlink" href="#Creating-a-tf.train.Example-message" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Suppose you want to create a <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> message from existing data. In practice, the dataset may come from anywhere, but the procedure of creating the <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> message from a single observation will be the same:</p>
<ol class="arabic simple">
<li><p>Within each observation, each value needs to be converted to a <code class="docutils literal notranslate"><span class="pre">tf.train.Feature</span></code> containing one of the 3 compatible types, using one of the functions above.</p></li>
<li><p>You create a map (dictionary) from the feature name string to the encoded feature value produced in #1.</p></li>
<li><p>The map produced in step 2 is converted to a <code class="docutils literal notranslate"><span class="pre">`Features</span></code> message &lt;<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/example/feature.proto#L85">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/example/feature.proto#L85</a>&gt;`__.</p></li>
</ol>
<p>In this notebook, you will create a dataset using NumPy.</p>
<p>This dataset will have 4 features:</p>
<ul class="simple">
<li><p>a boolean feature, <code class="docutils literal notranslate"><span class="pre">False</span></code> or <code class="docutils literal notranslate"><span class="pre">True</span></code> with equal probability</p></li>
<li><p>an integer feature uniformly randomly chosen from <code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">5]</span></code></p></li>
<li><p>a string feature generated from a string table by using the integer feature as an index</p></li>
<li><p>a float feature from a standard normal distribution</p></li>
</ul>
<p>Consider a sample consisting of 10,000 independently and identically distributed observations from each of the above distributions:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># The number of observations in the dataset.</span>
<span class="n">n_observations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">)</span>

<span class="c1"># Boolean feature, encoded as False or True.</span>
<span class="n">feature0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span> <span class="n">n_observations</span><span class="p">)</span>

<span class="c1"># Integer feature, random from 0 to 4.</span>
<span class="n">feature1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">n_observations</span><span class="p">)</span>

<span class="c1"># String feature</span>
<span class="n">strings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="sa">b</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;chicken&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;horse&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;goat&#39;</span><span class="p">])</span>
<span class="n">feature2</span> <span class="o">=</span> <span class="n">strings</span><span class="p">[</span><span class="n">feature1</span><span class="p">]</span>

<span class="c1"># Float feature, from a standard normal distribution</span>
<span class="n">feature3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_observations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Each of these features can be coerced into a <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code>-compatible type using one of <code class="docutils literal notranslate"><span class="pre">_bytes_feature</span></code>, <code class="docutils literal notranslate"><span class="pre">_float_feature</span></code>, <code class="docutils literal notranslate"><span class="pre">_int64_feature</span></code>. You can then create a <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> message from these encoded features:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">serialize_example</span><span class="p">(</span><span class="n">feature0</span><span class="p">,</span> <span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">,</span> <span class="n">feature3</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Creates a tf.train.Example message ready to be written to a file.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># Create a dictionary mapping the feature name to the tf.train.Example-compatible</span>
  <span class="c1"># data type.</span>
  <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;feature0&#39;</span><span class="p">:</span> <span class="n">_int64_feature</span><span class="p">(</span><span class="n">feature0</span><span class="p">),</span>
      <span class="s1">&#39;feature1&#39;</span><span class="p">:</span> <span class="n">_int64_feature</span><span class="p">(</span><span class="n">feature1</span><span class="p">),</span>
      <span class="s1">&#39;feature2&#39;</span><span class="p">:</span> <span class="n">_bytes_feature</span><span class="p">(</span><span class="n">feature2</span><span class="p">),</span>
      <span class="s1">&#39;feature3&#39;</span><span class="p">:</span> <span class="n">_float_feature</span><span class="p">(</span><span class="n">feature3</span><span class="p">),</span>
  <span class="p">}</span>

  <span class="c1"># Create a Features message using tf.train.Example.</span>

  <span class="n">example_proto</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">example_proto</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>For example, suppose you have a single observation from the dataset, <code class="docutils literal notranslate"><span class="pre">[False,</span> <span class="pre">4,</span> <span class="pre">bytes('goat'),</span> <span class="pre">0.9876]</span></code>. You can create and print the <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> message for this observation using <code class="docutils literal notranslate"><span class="pre">create_message()</span></code>. Each single observation will be written as a <code class="docutils literal notranslate"><span class="pre">Features</span></code> message as per the above. Note that the <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> <a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/core/example/example.proto#L88">message</a> is just a wrapper around the <code class="docutils literal notranslate"><span class="pre">Features</span></code> message:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># This is an example observation from the dataset.</span>

<span class="n">example_observation</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">serialized_example</span> <span class="o">=</span> <span class="n">serialize_example</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;goat&#39;</span><span class="p">,</span> <span class="mf">0.9876</span><span class="p">)</span>
<span class="n">serialized_example</span>
</pre></div>
</div>
</div>
<p>To decode the message use the <code class="docutils literal notranslate"><span class="pre">tf.train.Example.FromString</span></code> method.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">example_proto</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="o">.</span><span class="n">FromString</span><span class="p">(</span><span class="n">serialized_example</span><span class="p">)</span>
<span class="n">example_proto</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="TFRecords-format-details">
<h2>TFRecords format details<a class="headerlink" href="#TFRecords-format-details" title="Enlazar permanentemente con este título">¶</a></h2>
<p>A TFRecord file contains a sequence of records. The file can only be read sequentially.</p>
<p>Each record contains a byte-string, for the data-payload, plus the data-length, and CRC32C (32-bit CRC using the Castagnoli polynomial) hashes for integrity checking.</p>
<p>Each record is stored in the following formats:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>uint64 length
uint32 masked_crc32_of_length
byte   data[length]
uint32 masked_crc32_of_data
</pre></div>
</div>
<p>The records are concatenated together to produce the file. CRCs are <a class="reference external" href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">described here</a>, and the mask of a CRC is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>masked_crc = ((crc &gt;&gt; 15) | (crc &lt;&lt; 17)) + 0xa282ead8ul
</pre></div>
</div>
<p>Note: There is no requirement to use <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> in TFRecord files. <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> is just a method of serializing dictionaries to byte-strings. Any byte-string that can be decoded in TensorFlow could be stored in a TFRecord file. Examples include: Lines of text, JSON (using <code class="docutils literal notranslate"><span class="pre">tf.io.decode_json_example</span></code>), encoded image data, or serialized <code class="docutils literal notranslate"><span class="pre">tf.Tensors</span></code> (using <code class="docutils literal notranslate"><span class="pre">tf.io.serialize_tensor</span></code>/<code class="docutils literal notranslate"><span class="pre">tf.io.parse_tensor</span></code>). See the <code class="docutils literal notranslate"><span class="pre">tf.io</span></code> module for more options.</p>
</div>
<div class="section" id="TFRecord-files-using-tf.data">
<h2>TFRecord files using <code class="docutils literal notranslate"><span class="pre">tf.data</span></code><a class="headerlink" href="#TFRecord-files-using-tf.data" title="Enlazar permanentemente con este título">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> module also provides tools for reading and writing data in TensorFlow.</p>
<div class="section" id="Writing-a-TFRecord-file">
<h3>Writing a TFRecord file<a class="headerlink" href="#Writing-a-TFRecord-file" title="Enlazar permanentemente con este título">¶</a></h3>
<p>The easiest way to get the data into a dataset is to use the <code class="docutils literal notranslate"><span class="pre">from_tensor_slices</span></code> method.</p>
<p>Applied to an array, it returns a dataset of scalars:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">feature1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Applied to a tuple of arrays, it returns a dataset of tuples:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">features_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">feature0</span><span class="p">,</span> <span class="n">feature1</span><span class="p">,</span> <span class="n">feature2</span><span class="p">,</span> <span class="n">feature3</span><span class="p">))</span>
<span class="n">features_dataset</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Use `take(1)` to only pull one example from the dataset.</span>
<span class="k">for</span> <span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">f2</span><span class="p">,</span><span class="n">f3</span> <span class="ow">in</span> <span class="n">features_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">f0</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">f3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Use the <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset.map</span></code> method to apply a function to each element of a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>.</p>
<p>The mapped function must operate in TensorFlow graph mode—it must operate on and return <code class="docutils literal notranslate"><span class="pre">tf.Tensors</span></code>. A non-tensor function, like <code class="docutils literal notranslate"><span class="pre">serialize_example</span></code>, can be wrapped with <code class="docutils literal notranslate"><span class="pre">tf.py_function</span></code> to make it compatible.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">tf.py_function</span></code> requires to specify the shape and type information that is otherwise unavailable:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">tf_serialize_example</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">f2</span><span class="p">,</span><span class="n">f3</span><span class="p">):</span>
  <span class="n">tf_string</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">py_function</span><span class="p">(</span>
    <span class="n">serialize_example</span><span class="p">,</span>
    <span class="p">(</span><span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">f2</span><span class="p">,</span><span class="n">f3</span><span class="p">),</span>  <span class="c1"># pass these args to the above function.</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>      <span class="c1"># the return type is `tf.string`.</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf_string</span><span class="p">,</span> <span class="p">())</span> <span class="c1"># The result is a scalar</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">tf_serialize_example</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">f2</span><span class="p">,</span><span class="n">f3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Apply this function to each element in the dataset:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">serialized_features_dataset</span> <span class="o">=</span> <span class="n">features_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">tf_serialize_example</span><span class="p">)</span>
<span class="n">serialized_features_dataset</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
  <span class="k">for</span> <span class="n">features</span> <span class="ow">in</span> <span class="n">features_dataset</span><span class="p">:</span>
    <span class="k">yield</span> <span class="n">serialize_example</span><span class="p">(</span><span class="o">*</span><span class="n">features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">serialized_features_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span>
    <span class="n">generator</span><span class="p">,</span> <span class="n">output_types</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">output_shapes</span><span class="o">=</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">serialized_features_dataset</span>
</pre></div>
</div>
</div>
<p>And write them to a TFRecord file:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;test.tfrecord&#39;</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">serialized_features_dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Reading-a-TFRecord-file">
<h3>Reading a TFRecord file<a class="headerlink" href="#Reading-a-TFRecord-file" title="Enlazar permanentemente con este título">¶</a></h3>
<p>You can also read the TFRecord file using the <code class="docutils literal notranslate"><span class="pre">tf.data.TFRecordDataset</span></code> class.</p>
<p>More information on consuming TFRecord files using <code class="docutils literal notranslate"><span class="pre">tf.data</span></code> can be found <a class="reference external" href="https://www.tensorflow.org/guide/datasets#consuming_tfrecord_data">here</a>.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">TFRecordDataset</span></code>s can be useful for standardizing input data and optimizing performance.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span><span class="p">]</span>
<span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
<span class="n">raw_dataset</span>
</pre></div>
</div>
</div>
<p>At this point the dataset contains serialized <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> messages. When iterated over it returns these as scalar string tensors.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">.take</span></code> method to only show the first 10 records.</p>
<p>Note: iterating over a <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset</span></code> only works with eager execution enabled.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">raw_record</span> <span class="ow">in</span> <span class="n">raw_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">raw_record</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>These tensors can be parsed using the function below. Note that the <code class="docutils literal notranslate"><span class="pre">feature_description</span></code> is necessary here because datasets use graph-execution, and need this description to build their shape and type signature:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Create a description of the features.</span>
<span class="n">feature_description</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;feature0&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;feature1&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;feature2&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="s1">&#39;feature3&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_parse_function</span><span class="p">(</span><span class="n">example_proto</span><span class="p">):</span>
  <span class="c1"># Parse the input `tf.train.Example` proto using the dictionary above.</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">example_proto</span><span class="p">,</span> <span class="n">feature_description</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Alternatively, use <code class="docutils literal notranslate"><span class="pre">tf.parse</span> <span class="pre">example</span></code> to parse the whole batch at once. Apply this function to each item in the dataset using the <code class="docutils literal notranslate"><span class="pre">tf.data.Dataset.map</span></code> method:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">parsed_dataset</span> <span class="o">=</span> <span class="n">raw_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_parse_function</span><span class="p">)</span>
<span class="n">parsed_dataset</span>
</pre></div>
</div>
</div>
<p>Use eager execution to display the observations in the dataset. There are 10,000 observations in this dataset, but you will only display the first 10. The data is displayed as a dictionary of features. Each item is a <code class="docutils literal notranslate"><span class="pre">tf.Tensor</span></code>, and the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> element of this tensor displays the value of the feature:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">parsed_record</span> <span class="ow">in</span> <span class="n">parsed_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">parsed_record</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">tf.parse_example</span></code> function unpacks the <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> fields into standard tensors.</p>
</div>
</div>
<div class="section" id="TFRecord-files-in-Python">
<h2>TFRecord files in Python<a class="headerlink" href="#TFRecord-files-in-Python" title="Enlazar permanentemente con este título">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">tf.io</span></code> module also contains pure-Python functions for reading and writing TFRecord files.</p>
<div class="section" id="id9">
<h3>Writing a TFRecord file<a class="headerlink" href="#id9" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Next, write the 10,000 observations to the file <code class="docutils literal notranslate"><span class="pre">test.tfrecord</span></code>. Each observation is converted to a <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> message, then written to file. You can then verify that the file <code class="docutils literal notranslate"><span class="pre">test.tfrecord</span></code> has been created:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Write the `tf.train.Example` observations to the file.</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_observations</span><span class="p">):</span>
    <span class="n">example</span> <span class="o">=</span> <span class="n">serialize_example</span><span class="p">(</span><span class="n">feature0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">feature1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">feature2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">feature3</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>du -sh <span class="o">{</span>filename<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id10">
<h3>Reading a TFRecord file<a class="headerlink" href="#id10" title="Enlazar permanentemente con este título">¶</a></h3>
<p>These serialized tensors can be easily parsed using <code class="docutils literal notranslate"><span class="pre">tf.train.Example.ParseFromString</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">filename</span><span class="p">]</span>
<span class="n">raw_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
<span class="n">raw_dataset</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">raw_record</span> <span class="ow">in</span> <span class="n">raw_dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">example</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">()</span>
  <span class="n">example</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">raw_record</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Walkthrough:-Reading-and-writing-image-data">
<h2>Walkthrough: Reading and writing image data<a class="headerlink" href="#Walkthrough:-Reading-and-writing-image-data" title="Enlazar permanentemente con este título">¶</a></h2>
<p>This is an end-to-end example of how to read and write image data using TFRecords. Using an image as input data, you will write the data as a TFRecord file, then read the file back and display the image.</p>
<p>This can be useful if, for example, you want to use several models on the same input dataset. Instead of storing the image data raw, it can be preprocessed into the TFRecords format, and that can be used in all further processing and modelling.</p>
<p>First, let’s download <a class="reference external" href="https://commons.wikimedia.org/wiki/File:Felis_catus-cat_on_snow.jpg">this image</a> of a cat in the snow and <a class="reference external" href="https://upload.wikimedia.org/wikipedia/commons/f/fe/New_East_River_Bridge_from_Brooklyn_det.4a09796u.jpg">this photo</a> of the Williamsburg Bridge, NYC under construction.</p>
<div class="section" id="Fetch-the-images">
<h3>Fetch the images<a class="headerlink" href="#Fetch-the-images" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cat_in_snow</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="s1">&#39;320px-Felis_catus-cat_on_snow.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;https://storage.googleapis.com/download.tensorflow.org/example_images/320px-Felis_catus-cat_on_snow.jpg&#39;</span><span class="p">)</span>
<span class="n">williamsburg_bridge</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="s1">&#39;194px-New_East_River_Bridge_from_Brooklyn_det.4a09796u.jpg&#39;</span><span class="p">,</span><span class="s1">&#39;https://storage.googleapis.com/download.tensorflow.org/example_images/194px-New_East_River_Bridge_from_Brooklyn_det.4a09796u.jpg&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">cat_in_snow</span><span class="p">))</span>
<span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s1">&#39;Image cc-by: &lt;a &quot;href=https://commons.wikimedia.org/wiki/File:Felis_catus-cat_on_snow.jpg&quot;&gt;Von.grzanka&lt;/a&gt;&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">williamsburg_bridge</span><span class="p">))</span>
<span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="s1">&#39;&lt;a &quot;href=https://commons.wikimedia.org/wiki/File:New_East_River_Bridge_from_Brooklyn_det.4a09796u.jpg&quot;&gt;From Wikimedia&lt;/a&gt;&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Write-the-TFRecord-file">
<h3>Write the TFRecord file<a class="headerlink" href="#Write-the-TFRecord-file" title="Enlazar permanentemente con este título">¶</a></h3>
<p>As before, encode the features as types compatible with <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code>. This stores the raw image string feature, as well as the height, width, depth, and arbitrary <code class="docutils literal notranslate"><span class="pre">label</span></code> feature. The latter is used when you write the file to distinguish between the cat image and the bridge image. Use <code class="docutils literal notranslate"><span class="pre">0</span></code> for the cat image, and <code class="docutils literal notranslate"><span class="pre">1</span></code> for the bridge image:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">image_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">cat_in_snow</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">williamsburg_bridge</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># This is an example, just using the cat image.</span>
<span class="n">image_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">cat_in_snow</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">label</span> <span class="o">=</span> <span class="n">image_labels</span><span class="p">[</span><span class="n">cat_in_snow</span><span class="p">]</span>

<span class="c1"># Create a dictionary with features that may be relevant.</span>
<span class="k">def</span> <span class="nf">image_example</span><span class="p">(</span><span class="n">image_string</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
  <span class="n">image_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image_string</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>

  <span class="n">feature</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">_int64_feature</span><span class="p">(</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
      <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">_int64_feature</span><span class="p">(</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
      <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">_int64_feature</span><span class="p">(</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
      <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">_int64_feature</span><span class="p">(</span><span class="n">label</span><span class="p">),</span>
      <span class="s1">&#39;image_raw&#39;</span><span class="p">:</span> <span class="n">_bytes_feature</span><span class="p">(</span><span class="n">image_string</span><span class="p">),</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Example</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Features</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">))</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_example</span><span class="p">(</span><span class="n">image_string</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="mi">15</span><span class="p">]:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Notice that all of the features are now stored in the <code class="docutils literal notranslate"><span class="pre">tf.train.Example</span></code> message. Next, functionalize the code above and write the example messages to a file named <code class="docutils literal notranslate"><span class="pre">images.tfrecords</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Write the raw image files to `images.tfrecords`.</span>
<span class="c1"># First, process the two images into `tf.train.Example` messages.</span>
<span class="c1"># Then, write to a `.tfrecords` file.</span>
<span class="n">record_file</span> <span class="o">=</span> <span class="s1">&#39;images.tfrecords&#39;</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">TFRecordWriter</span><span class="p">(</span><span class="n">record_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">image_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">image_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">tf_example</span> <span class="o">=</span> <span class="n">image_example</span><span class="p">(</span><span class="n">image_string</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tf_example</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>du -sh <span class="o">{</span>record_file<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Read-the-TFRecord-file">
<h3>Read the TFRecord file<a class="headerlink" href="#Read-the-TFRecord-file" title="Enlazar permanentemente con este título">¶</a></h3>
<p>You now have the file—<code class="docutils literal notranslate"><span class="pre">images.tfrecords</span></code>—and can now iterate over the records in it to read back what you wrote. Given that in this example you will only reproduce the image, the only feature you will need is the raw image string. Extract it using the getters described above, namely <code class="docutils literal notranslate"><span class="pre">example.features.feature['image_raw'].bytes_list.value[0]</span></code>. You can also use the labels to determine which record is the cat and which one is the bridge:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">raw_image_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">(</span><span class="s1">&#39;images.tfrecords&#39;</span><span class="p">)</span>

<span class="c1"># Create a dictionary describing the features.</span>
<span class="n">image_feature_description</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="s1">&#39;image_raw&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">([],</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">_parse_image_function</span><span class="p">(</span><span class="n">example_proto</span><span class="p">):</span>
  <span class="c1"># Parse the input tf.train.Example proto using the dictionary above.</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">example_proto</span><span class="p">,</span> <span class="n">image_feature_description</span><span class="p">)</span>

<span class="n">parsed_image_dataset</span> <span class="o">=</span> <span class="n">raw_image_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_parse_image_function</span><span class="p">)</span>
<span class="n">parsed_image_dataset</span>
</pre></div>
</div>
</div>
<p>Recover the images from the TFRecord file:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">image_features</span> <span class="ow">in</span> <span class="n">parsed_image_dataset</span><span class="p">:</span>
  <span class="n">image_raw</span> <span class="o">=</span> <span class="n">image_features</span><span class="p">[</span><span class="s1">&#39;image_raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
  <span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">image_raw</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Derechos de autor 2019, Juan D. Velasquez.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>